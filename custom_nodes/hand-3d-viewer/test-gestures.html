<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手势功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button-group {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            background: #007bff;
            color: white;
            transition: all 0.2s ease;
        }
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        .gesture-btn {
            background: #28a745;
        }
        .gesture-btn:hover {
            background: #1e7e34;
        }
        .info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .joint-info {
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🖐️ 手部3D查看器手势功能测试</h1>
        
        <div class="info">
            <h3>使用说明：</h3>
            <p>1. 首先在Node-RED编辑器中启动手部3D查看器</p>
            <p>2. 确保侧边栏中的手部模型已加载完成</p>
            <p>3. 使用下面的按钮来测试手势功能</p>
            <p>4. 打开浏览器控制台查看详细日志</p>
        </div>

        <h3>🎮 手势控制</h3>
        <div class="button-group">
            <button class="gesture-btn" onclick="testGesture('rock')">✊ 石头</button>
            <button class="gesture-btn" onclick="testGesture('paper')">✋ 布</button>
            <button class="gesture-btn" onclick="testGesture('scissors')">✌️ 剪刀</button>
            <button onclick="testNaturalPose()">🖐️ 自然姿态</button>
        </div>

        <h3>🎯 高级功能</h3>
        <div class="button-group">
            <button onclick="testRandomGesture()">🎲 随机手势</button>
            <button onclick="testDemoGestures()">🎭 演示所有手势</button>
            <button onclick="testSwitchHand('left')">👈 切换到左手</button>
            <button onclick="testSwitchHand('right')">👉 切换到右手</button>
        </div>

        <h3>🔧 调试功能</h3>
        <div class="button-group">
            <button onclick="getHandInfo()">📊 获取手部信息</button>
            <button onclick="getJointAngles()">📐 获取关节角度</button>
            <button onclick="testJointControl()">🔧 测试关节控制</button>
            <button onclick="clearLog()">🧹 清空日志</button>
        </div>

        <h3>📋 日志输出</h3>
        <div id="log" class="joint-info" style="min-height: 100px;">
            等待测试...
        </div>
    </div>

    <script>
        let logContent = '';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(message);
        }

        function clearLog() {
            logContent = '';
            document.getElementById('log').textContent = '日志已清空...';
        }

        function checkHandViewer() {
            if (typeof window.Hand3DViewer === 'undefined') {
                log('❌ 错误: Hand3DViewer 未找到，请先启动Node-RED手部3D查看器');
                return false;
            }
            if (!window.Hand3DViewer.currentModel) {
                log('❌ 错误: 手部模型未加载，请等待模型加载完成');
                return false;
            }
            return true;
        }

        function testGesture(gestureName) {
            log(`🎯 测试手势: ${gestureName}`);
            
            if (!checkHandViewer()) return;
            
            try {
                if (window.Hand3DViewer.Gestures) {
                    const success = window.Hand3DViewer.Gestures.applyGesture(gestureName);
                    if (success) {
                        log(`✅ 手势 "${gestureName}" 应用成功`);
                    } else {
                        log(`❌ 手势 "${gestureName}" 应用失败`);
                    }
                } else {
                    log('❌ 错误: 手势控制模块未加载');
                }
            } catch (error) {
                log(`❌ 手势应用出错: ${error.message}`);
            }
        }

        function testNaturalPose() {
            log('🖐️ 测试自然姿态');
            
            if (!checkHandViewer()) return;
            
            try {
                if (window.Hand3DViewer.Gestures) {
                    window.Hand3DViewer.Gestures.resetToNaturalPose();
                    log('✅ 已重置到自然姿态');
                } else {
                    log('❌ 错误: 手势控制模块未加载');
                }
            } catch (error) {
                log(`❌ 自然姿态设置出错: ${error.message}`);
            }
        }

        function testRandomGesture() {
            log('🎲 测试随机手势');
            
            if (!checkHandViewer()) return;
            
            try {
                if (window.Hand3DViewer.Gestures) {
                    const gestureKey = window.Hand3DViewer.Gestures.randomGesture();
                    log(`✅ 随机手势: ${gestureKey}`);
                } else {
                    log('❌ 错误: 手势控制模块未加载');
                }
            } catch (error) {
                log(`❌ 随机手势出错: ${error.message}`);
            }
        }

        function testDemoGestures() {
            log('🎭 开始手势演示');
            
            if (!checkHandViewer()) return;
            
            try {
                if (window.Hand3DViewer.Gestures) {
                    window.Hand3DViewer.Gestures.demonstrateGestures(2500);
                    log('✅ 手势演示已开始，请观察手部模型');
                } else {
                    log('❌ 错误: 手势控制模块未加载');
                }
            } catch (error) {
                log(`❌ 手势演示出错: ${error.message}`);
            }
        }

        function testSwitchHand(handType) {
            log(`👋 切换到${handType === 'left' ? '左手' : '右手'}`);
            
            try {
                if (window.Hand3DViewer && window.Hand3DViewer.switchHand) {
                    window.Hand3DViewer.switchHand(handType);
                    log(`✅ 已切换到${handType === 'left' ? '左手' : '右手'}`);
                } else {
                    log('❌ 错误: 手型切换功能未找到');
                }
            } catch (error) {
                log(`❌ 手型切换出错: ${error.message}`);
            }
        }

        function getHandInfo() {
            log('📊 获取手部信息');
            
            if (!checkHandViewer()) return;
            
            try {
                const handType = window.Hand3DViewer.currentHandType || 'unknown';
                const hasModel = !!window.Hand3DViewer.currentModel;
                const hasLoader = !!window.Hand3DViewer.urdfLoader;
                const hasGestures = !!window.Hand3DViewer.Gestures;
                
                log(`✅ 当前手型: ${handType}`);
                log(`✅ 模型加载: ${hasModel ? '是' : '否'}`);
                log(`✅ URDF加载器: ${hasLoader ? '是' : '否'}`);
                log(`✅ 手势模块: ${hasGestures ? '是' : '否'}`);
                
                if (hasGestures) {
                    const availableGestures = window.Hand3DViewer.Gestures.getAvailableGestures();
                    log(`✅ 可用手势: ${availableGestures.map(g => g.name).join(', ')}`);
                }
            } catch (error) {
                log(`❌ 获取手部信息出错: ${error.message}`);
            }
        }

        function getJointAngles() {
            log('📐 获取关节角度');
            
            if (!checkHandViewer()) return;
            
            try {
                if (window.Hand3DViewer.currentModel && window.Hand3DViewer.currentModel.joints) {
                    const joints = window.Hand3DViewer.currentModel.joints;
                    log(`✅ 发现 ${Object.keys(joints).length} 个关节:`);
                    
                    Object.keys(joints).forEach(jointName => {
                        const angle = joints[jointName].getValue();
                        log(`  - ${jointName}: ${angle.toFixed(3)} rad`);
                    });
                } else {
                    log('❌ 错误: 关节信息不可用');
                }
            } catch (error) {
                log(`❌ 获取关节角度出错: ${error.message}`);
            }
        }

        function testJointControl() {
            log('🔧 测试单个关节控制');
            
            if (!checkHandViewer()) return;
            
            try {
                // 测试控制食指MCP关节
                const handType = window.Hand3DViewer.currentHandType || 'left';
                const jointName = `index_MCP_${handType.toUpperCase()[0]}`;
                
                log(`✅ 测试关节: ${jointName}`);
                
                // 先获取当前角度
                const currentAngle = window.Hand3DViewer.getJointAngle(jointName);
                log(`  当前角度: ${currentAngle.toFixed(3)} rad`);
                
                // 设置新角度
                const newAngle = 0.8;
                window.Hand3DViewer.setJointAngle(jointName, newAngle);
                log(`  设置新角度: ${newAngle} rad`);
                
                // 验证设置是否成功
                setTimeout(() => {
                    const verifyAngle = window.Hand3DViewer.getJointAngle(jointName);
                    log(`  验证角度: ${verifyAngle.toFixed(3)} rad`);
                    
                    // 恢复原始角度
                    window.Hand3DViewer.setJointAngle(jointName, currentAngle);
                    log(`  已恢复原始角度: ${currentAngle.toFixed(3)} rad`);
                }, 1000);
                
            } catch (error) {
                log(`❌ 关节控制测试出错: ${error.message}`);
            }
        }

        // 页面加载完成后的初始检查
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('🚀 手势功能测试页面已加载');
                log('📝 请确保已在Node-RED中启动手部3D查看器');
                
                // 检查是否可以访问Hand3DViewer
                if (typeof window.Hand3DViewer !== 'undefined') {
                    log('✅ Hand3DViewer 已找到');
                } else {
                    log('❌ Hand3DViewer 未找到，请先启动Node-RED手部3D查看器');
                }
            }, 1000);
        });
    </script>
</body>
</html>