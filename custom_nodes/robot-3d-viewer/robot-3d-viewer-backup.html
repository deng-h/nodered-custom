<script type="text/html" data-template-name="robot-3d-viewer">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-tips">
        <b>提示:</b> 这个节点用于加载机器人3D查看器到侧边栏。
    </div>
</script>
<!-- CSS Styles -->
<style>
/* Robot 3D Viewer 样式 */
.robot-3d-viewer-panel {
    font-family: Arial, sans-serif;
}

.robot-3d-viewer-panel h3 {
    border-bottom: 2px solid #0077be;
    padding-bottom: 8px;
}

.viewer-controls {
    border: 1px solid #ddd;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.viewer-controls label {
    font-weight: bold;
    color: #495057;
}

.viewer-controls select {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
}

.toggle-btn.active {
    transform: scale(0.95);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

#robot-3d-container {
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    transition: border-color 0.3s ease;
}

#robot-3d-container:hover {
    border-color: #0077be;
}

.viewer-info {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #ddd;
    font-family: 'Courier New', monospace;
}

#loading-indicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

canvas {
    display: block;
    outline: none;
    cursor: grab;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
}

canvas:active {
    cursor: grabbing;
}

/* 防止3D容器内的文本选择和右键菜单 */
#robot-3d-container {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
}

/* 设置面板样式 */
.settings-panel {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 4px;
    overflow: hidden;
}

.settings-header {
    transition: background-color 0.2s ease;
}

.settings-header:hover {
    background: #dee2e6 !important;
}

.settings-header:active {
    background: #ced4da !important;
}

#settings-toggle-icon {
    transition: transform 0.2s ease;
}

/* 滑动条样式优化 */
.slider-group input[type="range"] {
    height: 4px;
    background: #ddd;
    border-radius: 2px;
    outline: none;
    -webkit-appearance: none;
}

.slider-group input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.slider-group input[type="range"]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #007bff;
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* 紧凑的按钮样式 */
.red-ui-button.toggle-btn {
    border-radius: 3px;
    transition: all 0.2s ease;
}

.red-ui-button.toggle-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style>
<!-- JavaScript Modules -->
<script type="text/javascript">
    // 初始化全局命名空间
    window.Robot3DViewer = {};
</script>

<!-- 依赖加载模块 -->
<script type="text/javascript">
// Robot 3D Viewer - Dependencies Loader
(function() {
    "use strict";
    
    let isThreeJSLoaded = false;
    let dependenciesLoaded = false;
    
    function loadThreeJS(callback) {
        if (window.THREE) {
            isThreeJSLoaded = true;
            callback();
            return;
        }
        
        const cdnUrls = [
            'https://unpkg.com/three@0.147.0/build/three.min.js',
            'https://cdn.jsdelivr.net/npm/three@0.147.0/build/three.min.js',
            'https://threejs.org/build/three.min.js',
            './static/three.min.js'  // 本地备选
        ];
        
        let currentIndex = 0;
        
        function tryLoadFromCDN() {
            if (currentIndex >= cdnUrls.length) {
                console.error("All sources failed, using fallback display");
                RED.notify("Three.js库加载失败", { 
                    type: "error", 
                    timeout: 5000 
                });
                return;
            }
            
            const script = document.createElement('script');
            script.src = cdnUrls[currentIndex];
            
            script.onload = function() {
                console.log("DEBUG: Three.js 加载成功");
                isThreeJSLoaded = true;
                callback();
            };
            
            script.onerror = function() {
                console.warn("Failed to load from:", cdnUrls[currentIndex]);
                currentIndex++;
                setTimeout(tryLoadFromCDN, 100); // 延迟重试
            };
            
            document.head.appendChild(script);
        }
        
        tryLoadFromCDN();
    }
    
    function loadDependencies(callback) {
        if (dependenciesLoaded) {
            callback();
            return;
        }

        loadThreeJS(function() {
            loadScript('./static/OrbitControls.js', 'OrbitControls', function() {
                loadScript('./static/ColladaLoader.js', 'ColladaLoader', function() {
                    loadScript('./static/URDFLoader.js', 'URDFLoader', function() {
                        console.log("DEBUG: All 3D dependencies (OrbitControls, ColladaLoader, URDFLoader) loaded successfully.");
                        dependenciesLoaded = true;
                        callback();
                    });
                });
            });
        });
    }

    // 通用的脚本加载函数
    function loadScript(url, checkObject, callback) {
        // 检查对象是否已存在于 THREE 或 window
        if ((window.THREE && window.THREE[checkObject]) || window[checkObject]) {
            console.log(`DEBUG: ${checkObject} is already loaded.`);
            callback();
            return;
        }

        const script = document.createElement('script');
        script.src = url;
        script.async = false; // 确保脚本按顺序执行

        script.onload = function() {
            console.log(`DEBUG: ${checkObject} loaded successfully from ${url}`);
            callback();
        };

        script.onerror = function() {
            console.error(`ERROR: Failed to load ${checkObject} from ${url}`);
            RED.notify(`依赖库 ${checkObject} 加载失败`, { type: "error", timeout: 5000 });
        };

        document.head.appendChild(script);
    }
    
    // 暴露给全局
    window.Robot3DViewer = window.Robot3DViewer || {};
    window.Robot3DViewer.loadDependencies = loadDependencies;
    window.Robot3DViewer.isThreeJSLoaded = function() { return isThreeJSLoaded; };
    Object.defineProperty(window.Robot3DViewer, 'dependenciesLoaded', {
        get: function() { return dependenciesLoaded; }
    });
})();
</script>

<!-- 注释系统模块 -->
<script type="text/javascript">
// Robot 3D Viewer - Annotations System
(function() {
    "use strict";
    
    // ===== 注释(关节状态)相关全局 =====
    // 保存关节注释对象: { name, jointObject, labelEl, lineEl, temperature }
    let jointAnnotations = [];
    let annotationOverlay = null; // div 容器
    let annotationSVG = null;     // svg 容器 (画线)

    // 初始化注释 overlay (只需一次)
    function ensureAnnotationOverlay() {
        if (annotationOverlay) return;
        const container = document.getElementById('robot-3d-container');
        if (!container) return;
        annotationOverlay = document.createElement('div');
        annotationOverlay.className = 'robot-annotation-overlay';
        Object.assign(annotationOverlay.style, {
            position: 'absolute',
            top: 0,
            left: 0,
            width: '100%',
            height: '100%',
            pointerEvents: 'none', // 允许鼠标穿透到 Three.js 画布
            overflow: 'hidden'
        });
        // SVG 用于画连线
        annotationSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        annotationSVG.setAttribute('width', '100%');
        annotationSVG.setAttribute('height', '100%');
        annotationSVG.style.position = 'absolute';
        annotationSVG.style.top = '0';
        annotationSVG.style.left = '0';
        annotationOverlay.appendChild(annotationSVG);

        container.appendChild(annotationOverlay);
    }

    // 添加一个关节注释
    function addJointAnnotation(jointName, temperature) {
        if (!window.Robot3DViewer.currentModel) {
            console.warn('addJointAnnotation: model not ready');
            return;
        }
        ensureAnnotationOverlay();
        const jointObj = findJointObject(jointName);
        if (!jointObj) {
            console.warn('Joint not found for annotation:', jointName);
            return;
        }
        // 创建标签元素
        const label = document.createElement('div');
        label.className = 'joint-annotation-label';
        label.innerHTML = `<strong>${jointName}</strong><br><span class="temp">${formatTemperature(temperature)}</span>`;
        Object.assign(label.style, {
            position: 'absolute',
            transform: 'translate(-50%, -50%)',
            background: 'rgba(0,0,0,0.7)',
            color: '#fff',
            fontSize: '11px',
            lineHeight: '14px',
            padding: '4px 6px',
            borderRadius: '4px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.4)',
            whiteSpace: 'nowrap',
            pointerEvents: 'auto', // 允许未来添加交互
            cursor: 'default'
        });

        annotationOverlay.appendChild(label);

        // 创建线条元素 (SVG line)
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('stroke', '#ffcc00');
        line.setAttribute('stroke-width', '1.5');
        line.setAttribute('marker-end', 'url(#arrowhead)');

        // 定义一次 marker (如果还没有)
        if (!annotationSVG.querySelector('marker#arrowhead')) {
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '6');
            marker.setAttribute('markerHeight', '6');
            marker.setAttribute('refX', '5');
            marker.setAttribute('refY', '3');
            marker.setAttribute('orient', 'auto');
            const markerPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            markerPath.setAttribute('d', 'M0,0 L6,3 L0,6 Z');
            markerPath.setAttribute('fill', '#ffcc00');
            marker.appendChild(markerPath);
            defs.appendChild(marker);
            annotationSVG.appendChild(defs);
        }

        annotationSVG.appendChild(line);

        const ann = { name: jointName, jointObject: jointObj, labelEl: label, lineEl: line, temperature };
        jointAnnotations.push(ann);
        updateAnnotations();
    }

    function updateJointTemperature(jointName, temperature) {
        const ann = jointAnnotations.find(a => a.name === jointName);
        if (!ann) return;
        ann.temperature = temperature;
        const tempEl = ann.labelEl.querySelector('.temp');
        if (tempEl) tempEl.textContent = formatTemperature(temperature);
    }

    function formatTemperature(t) {
        if (t == null || isNaN(t)) return 'N/A';
        return t.toFixed(1) + '°C';
    }

    // 遍历查找关节对象 (名称包含)
    function findJointObject(jointName) {
        let found = null;
        if (!window.Robot3DViewer.currentModel) return null;
        window.Robot3DViewer.currentModel.traverse(obj => {
            if (found) return; // 已找到
            if (obj.name && obj.name.toLowerCase().includes(jointName.toLowerCase())) {
                found = obj;
            }
        });
        return found;
    }

    // 更新所有注释的屏幕位置 & 连线
    function updateAnnotations() {
        if (!window.Robot3DViewer.camera || !window.Robot3DViewer.renderer || !annotationOverlay || jointAnnotations.length === 0) return;
        const rect = window.Robot3DViewer.renderer.domElement.getBoundingClientRect();
        jointAnnotations.forEach(ann => {
            if (!ann.jointObject) return;
            const worldPos = new THREE.Vector3();
            ann.jointObject.getWorldPosition(worldPos);
            // 投影到标准化设备坐标
            worldPos.project(window.Robot3DViewer.camera);
            // 转换为屏幕像素坐标
            const x = (worldPos.x * 0.5 + 0.5) * rect.width;
            const y = (-worldPos.y * 0.5 + 0.5) * rect.height;

            // 视锥裁剪(在后面或超出范围隐藏)
            const visible = worldPos.z < 1 && worldPos.z > -1 && worldPos.x >= -1 && worldPos.x <= 1 && worldPos.y >= -1 && worldPos.y <= 1;
            ann.labelEl.style.display = visible ? 'block' : 'none';
            ann.lineEl.style.display = visible ? 'block' : 'none';
            if (!visible) return;

            ann.labelEl.style.left = x + 'px';
            ann.labelEl.style.top = y + 'px';

            // 线条起点(关节) -> 终点(标签上方稍偏移)
            const labelRect = ann.labelEl.getBoundingClientRect();
            const overlayRect = rect; // 坐标系相同 (absolute 叠在容器上)
            const labelCenterX = parseFloat(ann.labelEl.style.left);
            const labelCenterY = parseFloat(ann.labelEl.style.top);
            const targetX = labelCenterX;
            const targetY = labelCenterY - labelRect.height * 0.5 - 6; // 上方 6px

            ann.lineEl.setAttribute('x1', x);
            ann.lineEl.setAttribute('y1', y);
            ann.lineEl.setAttribute('x2', targetX);
            ann.lineEl.setAttribute('y2', targetY);
        });
    }
    
    // 暴露给全局
    window.Robot3DViewer = window.Robot3DViewer || {};
    window.Robot3DViewer.addJointAnnotation = addJointAnnotation;
    window.Robot3DViewer.updateJointTemperature = updateJointTemperature;
    window.Robot3DViewer.updateAnnotations = updateAnnotations;
})();
</script>

<!-- 控制和事件模块 -->
<script type="text/javascript">
// Robot 3D Viewer - Controls and Events
(function() {
    "use strict";
    
    let autoRotate = false;
    let wireframeMode = false;
    
    // 绑定控制按钮事件
    function bindControlEvents() {
        // 设置面板折叠/展开
        $('.settings-header').off('click').on('click', function() {
            const settingsContent = $('#settings-content');
            const toggleIcon = $('#settings-toggle-icon');
            
            if (settingsContent.is(':visible')) {
                // 折叠
                settingsContent.slideUp(200);
                toggleIcon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
                toggleIcon.css('transform', 'rotate(0deg)');
            } else {
                // 展开
                settingsContent.slideDown(200);
                toggleIcon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
                toggleIcon.css('transform', 'rotate(0deg)');
            }
        });
        
        // 重置相机按钮
        $('#reset-camera-btn').off('click').on('click', function() {
            window.Robot3DViewer.camera.position.set(1, 1, 1);
            window.Robot3DViewer.camera.lookAt(0, 0, 0);
            if (window.Robot3DViewer.controls) {
                window.Robot3DViewer.controls.reset();
            }
            const INITIAL_ROBOT_POSITION = new THREE.Vector3(0, 0, 0);   // (x,y,z)
            const INITIAL_ROBOT_RPY = { roll: -1.98, pitch: -0.411, yaw: -0.96 }; // 角度（弧度制）

            // 应用姿态（roll=X, pitch=Y, yaw=Z，按 XYZ 顺序）
            window.Robot3DViewer.robot.rotation.set(
                INITIAL_ROBOT_RPY.roll,
                INITIAL_ROBOT_RPY.pitch,
                INITIAL_ROBOT_RPY.yaw,
                'XYZ'
            );       
            
            window.Robot3DViewer.robot.position.add(INITIAL_ROBOT_POSITION);            
        });
        
        // 自动旋转按钮
        $('#rotate-btn').off('click').on('click', function() {
            autoRotate = !autoRotate;
            $(this).toggleClass('active', autoRotate);
            if (autoRotate) {
                $(this).css('background-color', '#28a745');
            } else {
                $(this).css('background-color', '');
            }
        });
        
        // 线框模式按钮
        $('#wireframe-btn').off('click').on('click', function() {
            wireframeMode = !wireframeMode;
            $(this).toggleClass('active', wireframeMode);
            if (wireframeMode) {
                $(this).css('background-color', '#ffc107');
            } else {
                $(this).css('background-color', '');
            }
            
            // 切换所有网格的线框模式
            window.Robot3DViewer.scene.traverse(function(object) {
                if (object.isMesh && object.material) {
                    object.material.wireframe = wireframeMode;
                }
            });
        });

        // 新增：为所有姿态滑块绑定 input 事件
        $('#roll-slider, #pitch-slider, #yaw-slider').off('input').on('input', updateRobotPoseFromSliders);
    }
    
    // 更新机器人姿态
    function updateRobotPoseFromSliders() {
        if (!window.Robot3DViewer.currentModel) {
            return;
        }

        // 从滑块获取弧度值
        const roll = parseFloat($('#roll-slider').val());
        const pitch = parseFloat($('#pitch-slider').val());
        const yaw = parseFloat($('#yaw-slider').val());

        // 更新模型姿态 (使用弧度)
        // 'XYZ' 是欧拉角的旋转顺序，对于 RPY 通常是这个顺序
        window.Robot3DViewer.currentModel.rotation.set(roll, pitch, yaw, 'XYZ');

        // 更新UI显示的度数 (弧度 * 180 / PI)
        $('#roll-value').text((roll * 180 / Math.PI).toFixed(1) + '°');
        $('#pitch-value').text((pitch * 180 / Math.PI).toFixed(1) + '°');
        $('#yaw-value').text((yaw * 180 / Math.PI).toFixed(1) + '°');
    }
    
    // 设置事件监听器
    function setupEventListeners() {
        // 监听侧边栏切换
        RED.events.on("sidebar:resize", function() {
            setTimeout(window.Robot3DViewer.onWindowResize, 100);
        });
        
        console.log("DEBUG: Event listeners setup complete");
    }
    
    // 手动实现基础鼠标控制（当OrbitControls不可用时）
    function setupBasicMouseControls(canvas) {
        let isMouseDown = false;
        let mouseButton = null;
        let previousMousePosition = { x: 0, y: 0 };
        
        canvas.addEventListener('mousedown', function(e) {
            e.preventDefault();
            isMouseDown = true;
            mouseButton = e.button;
            previousMousePosition = { x: e.clientX, y: e.clientY };
            canvas.style.cursor = 'grabbing';
        });
        
        canvas.addEventListener('mouseup', function(e) {
            e.preventDefault();
            isMouseDown = false;
            mouseButton = null;
            canvas.style.cursor = 'grab';
        });
        
        canvas.addEventListener('mousemove', function(e) {
            if (!isMouseDown) return;
            e.preventDefault();
            
            const deltaX = e.clientX - previousMousePosition.x;
            const deltaY = e.clientY - previousMousePosition.y;
            
            if (mouseButton === 0) { // 左键旋转
                if (window.Robot3DViewer.currentModel) {
                    window.Robot3DViewer.currentModel.rotation.y += deltaX * 0.01;
                    window.Robot3DViewer.currentModel.rotation.x += deltaY * 0.01;
                }
            } else if (mouseButton === 2) { // 右键平移
                window.Robot3DViewer.camera.position.x -= deltaX * 0.01;
                window.Robot3DViewer.camera.position.y += deltaY * 0.01;
            }
            
            previousMousePosition = { x: e.clientX, y: e.clientY };
        });
        
        canvas.addEventListener('wheel', function(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 1.1 : 0.9;
            window.Robot3DViewer.camera.position.multiplyScalar(delta);
        });
        
        console.log("DEBUG: Basic mouse controls setup complete");
    }
    
    // 暴露给全局
    window.Robot3DViewer = window.Robot3DViewer || {};
    window.Robot3DViewer.bindControlEvents = bindControlEvents;
    window.Robot3DViewer.setupEventListeners = setupEventListeners;
    window.Robot3DViewer.setupBasicMouseControls = setupBasicMouseControls;
    window.Robot3DViewer.updateRobotPoseFromSliders = updateRobotPoseFromSliders;
    Object.defineProperty(window.Robot3DViewer, 'autoRotate', {
        get: function() { return autoRotate; }
    });
})();
</script>

<!-- 3D场景管理模块 -->
<script type="text/javascript">
// Robot 3D Viewer - 3D Scene Management
(function() {
    "use strict";
    
    // 3D场景相关变量
    let scene, camera, renderer, controls;
    let currentModel = null;
    let animationId = null;
    let robot = null;
    
    function initThreeJSScene() {
        if (!window.Robot3DViewer.dependenciesLoaded) {
            console.warn("DEBUG: Dependencies not loaded yet. Aborting scene init.");
            $('#loading-indicator').show().find('div').text('正在加载依赖库...');
            // 再次触发加载，以防万一
            window.Robot3DViewer.loadDependencies(function(){
                if ($('#robot-3d-container').is(':visible')) {
                    initThreeJSScene(); // 加载完后重试
                }
            });
            return;
        }

        const container = document.getElementById('robot-3d-container');
        if (!container || !window.Robot3DViewer.isThreeJSLoaded()) {
            console.log("DEBUG: Container not ready or Three.js not loaded");
            return;
        }
        
        $('#loading-indicator').hide();
        
        // 如果已经初始化过，清理旧的场景
        if (renderer) {
            container.removeChild(renderer.domElement);
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }
        
        // 创建场景
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xaaaaaa);
        
        // 创建相机
        const containerRect = container.getBoundingClientRect();
        camera = new THREE.PerspectiveCamera(75, containerRect.width / containerRect.height, 0.1, 1000);
        camera.position.set(1, 1, 1);
        camera.lookAt(0, 0, 0);
        
        // 创建渲染器
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(containerRect.width, containerRect.height);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);
        
        // 阻止浏览器默认的鼠标事件
        const canvas = renderer.domElement;
        canvas.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });
        
        canvas.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        canvas.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // 添加轨道控制器（如果可用）
        if (THREE.OrbitControls) {
            controls = new THREE.OrbitControls(camera, canvas);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.enablePan = true;
            controls.enableZoom = true;
            controls.enableRotate = true;
            
            // 自定义鼠标按键映射
            controls.mouseButtons = {
                LEFT: THREE.MOUSE.ROTATE,
                MIDDLE: THREE.MOUSE.DOLLY,
                RIGHT: THREE.MOUSE.PAN
            };
            
            // 触控设备支持
            controls.touches = {
                ONE: THREE.TOUCH.ROTATE,
                TWO: THREE.TOUCH.DOLLY_PAN
            };
            
            console.log("DEBUG: OrbitControls configured with custom mouse mapping");
        } else {
            console.warn("OrbitControls not available, using basic camera");
            // 手动实现基础的鼠标控制
            window.Robot3DViewer.setupBasicMouseControls(canvas);
        }
        
        // 添加光源
        setupLighting();
        
        // 创建模型
        createRobotModel();
        
        // 绑定控制按钮事件
        window.Robot3DViewer.bindControlEvents();
        
        // 开始渲染循环
        animate();
        
        // 处理窗口大小变化
        window.addEventListener('resize', onWindowResize);
        
        console.log("DEBUG: Three.js scene initialized with custom mouse controls");
    }
    
    // 设置光源
    function setupLighting() {
        // 环境光
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        // 主光源
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 1024;
        directionalLight.shadow.mapSize.height = 1024;
        scene.add(directionalLight);
        
        // 补充光源
        const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
        fillLight.position.set(-10, -10, -5);
        scene.add(fillLight);
        
        // 添加地面
        /*const groundGeometry = new THREE.PlaneGeometry(10, 10);
        const groundMaterial = new THREE.MeshLambertMaterial({ 
            color: 0xf0f0f0,
            transparent: true,
            opacity: 0.8
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2; // 旋转90度使其水平
        ground.position.y = -1; // 稍微下移，让机器人站在上面
        ground.receiveShadow = true; // 接收阴影
        scene.add(ground);*/
    }
    
    function createRobotModel() {
        // 清除旧模型
        if (currentModel) {
            scene.remove(currentModel);
            currentModel.traverse(child => {
                if (child.isMesh) {
                    child.geometry.dispose();
                    if (child.material.isMaterial) {
                        // 清理材质引用的纹理等
                        Object.values(child.material).forEach(value => {
                            if (value && typeof value.dispose === 'function') {
                                value.dispose();
                            }
                        });
                        child.material.dispose();
                    }
                }
            });
        }

        $('#loading-indicator').show();

        const loader = new URDFLoader();

        loader.workingPath = '/H1_Pro1/urdf/';
        loader.packages = { '': '/H1_Pro1' };
        const urdfPath = '/H1_Pro1/urdf/H1_Pro1.urdf';
        console.log("DEBUG: Starting to load URDF from:", urdfPath);

        loader.load(
            urdfPath,
            robot => {
                console.log("DEBUG: Robot model loaded successfully", robot);
                const box = new THREE.Box3().setFromObject(robot);
                const center = box.getCenter(new THREE.Vector3());
                robot.position.sub(center);
                
                const INITIAL_ROBOT_POSITION = new THREE.Vector3(0, 0, 0);   // (x,y,z)
                const INITIAL_ROBOT_RPY = { roll: -1.98, pitch: -0.411, yaw: -0.96 }; // 角度（弧度制）

                // 应用姿态（roll=X, pitch=Y, yaw=Z，按 XYZ 顺序）
                robot.rotation.set(
                    INITIAL_ROBOT_RPY.roll,
                    INITIAL_ROBOT_RPY.pitch,
                    INITIAL_ROBOT_RPY.yaw,
                    'XYZ'
                );       
                
                robot.position.add(INITIAL_ROBOT_POSITION);

                scene.add(robot);
                currentModel = robot;
                 // 新增：加载模型后，将滑块的初始值与模型的初始姿态同步
                $('#roll-slider').val(INITIAL_ROBOT_RPY.roll);
                $('#pitch-slider').val(INITIAL_ROBOT_RPY.pitch);
                $('#yaw-slider').val(INITIAL_ROBOT_RPY.yaw);
                
                // 新增：调用一次更新函数，来设置模型的初始姿态和UI显示
                window.Robot3DViewer.updateRobotPoseFromSliders();                   
                $('#loading-indicator').hide();

                // 假设关节名包含 HAND_L（需与模型节点名称匹配，可调试 console 输出）
                window.Robot3DViewer.addJointAnnotation('HAND_L', 42.3);
                window.Robot3DViewer.addJointAnnotation('HAND_R', 42.3);
                window.Robot3DViewer.addJointAnnotation('Shoulder_Y_L', 42.3);
                window.Robot3DViewer.addJointAnnotation('Shoulder_X_L', 42.3);
                window.Robot3DViewer.addJointAnnotation('Shoulder_Z_L', 42.3);
            },
            progress => {
                if (progress && progress.total > 0) {
                    const percent = Math.round(progress.loaded / progress.total * 100);
                    $('#loading-indicator div').text(`加载3D模型中... ${percent}%`);
                } else {
                    $('#loading-indicator div').text('加载3D模型中...');
                }
            },
            error => {
                console.error("ERROR: Failed to load URDF model.", error);
                RED.notify("机器人模型加载失败，请检查控制台和文件路径。", { type: "error", timeout: 8000 });
                $('#loading-indicator div').text('加载失败！');
            }
        );
    }
    
    // 动画循环
    function animate() {
        animationId = requestAnimationFrame(animate);
        
        // 自动旋转
        if (window.Robot3DViewer.autoRotate && currentModel) {
            currentModel.rotation.z += 0.01;
        }
        
        // 更新控制器
        if (controls) {
            controls.update();
        }
        
        // 渲染场景
        if (renderer && scene && camera) {
            renderer.render(scene, camera);
        }
        // 更新注释
        window.Robot3DViewer.updateAnnotations();
    }
    
    // 窗口大小变化处理
    function onWindowResize() {
        const container = document.getElementById('robot-3d-container');
        if (!container || !camera || !renderer) return;
        
        const containerRect = container.getBoundingClientRect();
        camera.aspect = containerRect.width / containerRect.height;
        camera.updateProjectionMatrix();
        renderer.setSize(containerRect.width, containerRect.height);
    }
    
    // 暴露给全局
    window.Robot3DViewer = window.Robot3DViewer || {};
    window.Robot3DViewer.initThreeJSScene = initThreeJSScene;
    window.Robot3DViewer.onWindowResize = onWindowResize;
    Object.defineProperty(window.Robot3DViewer, 'scene', {
        get: function() { return scene; }
    });
    Object.defineProperty(window.Robot3DViewer, 'camera', {
        get: function() { return camera; }
    });
    Object.defineProperty(window.Robot3DViewer, 'renderer', {
        get: function() { return renderer; }
    });
    Object.defineProperty(window.Robot3DViewer, 'controls', {
        get: function() { return controls; }
    });
    Object.defineProperty(window.Robot3DViewer, 'currentModel', {
        get: function() { return currentModel; }
    });
    Object.defineProperty(window.Robot3DViewer, 'robot', {
        get: function() { return robot; }
    });
})();
</script>

<!-- 侧边栏UI模块 -->
<script type="text/javascript">
// Robot 3D Viewer - Sidebar Panel
(function() {
    "use strict";
    
    function addRobot3DSidebar() {
        var sidebarContent = $(`
            <div class="robot-3d-viewer-panel" style="padding: 15px; height: 100%; display: flex; flex-direction: column;">
                <h3 style="margin-top: 0; color: #333; margin-bottom: 15px;">
                    <i class="fa fa-cube" style="margin-right: 8px;"></i>
                    机器人状态
                </h3>
                
                <!-- 可折叠的设置面板 -->
                <div class="settings-panel" style="margin-bottom: 15px;">
                    <div class="settings-header" style="background: #e9ecef; border-radius: 4px; padding: 8px 12px; cursor: pointer; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold; color: #495057;">
                            <i class="fa fa-cog" style="margin-right: 6px;"></i>
                            设置
                        </span>
                        <i id="settings-toggle-icon" class="fa fa-chevron-up" style="color: #6c757d; transition: transform 0.2s;"></i>
                    </div>
                    
                    <div id="settings-content" style="background: #f8f9fa; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; padding: 15px; display: none;">
                        <!-- 视图控制 -->
                        <div class="viewer-controls" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span style="font-weight: bold; color: #555; font-size: 13px;">视图控制</span>
                                <button id="reset-camera-btn" class="red-ui-button" style="font-size: 12px; padding: 4px 8px;">
                                    <i class="fa fa-refresh"></i> 重置视角
                                </button>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <button id="rotate-btn" class="red-ui-button toggle-btn" style="flex: 1; margin-right: 5px; font-size: 12px;">
                                    <i class="fa fa-repeat"></i> 自动旋转
                                </button>
                                <button id="wireframe-btn" class="red-ui-button toggle-btn" style="flex: 1; margin-left: 5px; font-size: 12px;">
                                    <i class="fa fa-object-group"></i> 线框模式
                                </button>
                            </div>
                        </div>

                        <!-- 姿态控制 -->
                        <div class="pose-controls">
                            <div style="font-weight: bold; color: #555; margin-bottom: 10px; font-size: 13px;">姿态控制 (RPY)</div>
                            <div class="slider-group" style="display: flex; align-items: center; margin-bottom: 8px;">
                                <label for="roll-slider" style="width: 45px; font-size: 11px; color: #666;">Roll</label>
                                <input type="range" id="roll-slider" min="-3.14159" max="3.14159" step="0.01" value="0.5" style="flex: 1; margin: 0 8px;">
                                <span id="roll-value" style="width: 45px; text-align: right; font-size: 11px; font-family: monospace; color: #666;">0.0°</span>
                            </div>
                            <div class="slider-group" style="display: flex; align-items: center; margin-bottom: 8px;">
                                <label for="pitch-slider" style="width: 45px; font-size: 11px; color: #666;">Pitch</label>
                                <input type="range" id="pitch-slider" min="-3.14159" max="3.14159" step="0.01" value="1.57" style="flex: 1; margin: 0 8px;">
                                <span id="pitch-value" style="width: 45px; text-align: right; font-size: 11px; font-family: monospace; color: #666;">0.0°</span>
                            </div>
                            <div class="slider-group" style="display: flex; align-items: center;">
                                <label for="yaw-slider" style="width: 45px; font-size: 11px; color: #666;">Yaw</label>
                                <input type="range" id="yaw-slider" min="-3.14159" max="3.14159" step="0.01" value="0" style="flex: 1; margin: 0 8px;">
                                <span id="yaw-value" style="width: 45px; text-align: right; font-size: 11px; font-family: monospace; color: #666;">0.0°</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 3D渲染区域 -->
                <div id="robot-3d-container" style="flex: 1; border: 2px solid #ddd; border-radius: 4px; background: #000; position: relative; min-height: 300px;">
                    <div id="loading-indicator" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                        <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>加载3D模型中...</div>
                    </div>
                </div>
            </div>
        `);
        
        RED.sidebar.addTab({
            id: "robot-3d-viewer",
            label: "3D模型",
            name: "机器人3D查看器",
            iconClass: "fa fa-cube",
            content: sidebarContent,
            enableOnEdit: false,
            onchange: function() {
                // 当侧边栏切换到3D查看器时
                if ($('#robot-3d-container').is(':visible') && window.Robot3DViewer.dependenciesLoaded) {
                     // 只有当依赖加载完成且面板可见时，才初始化或重新调整大小
                    if (!window.Robot3DViewer.renderer) { // 如果场景还未初始化
                        window.Robot3DViewer.initThreeJSScene();
                    } else { // 如果已初始化，仅调整大小
                        setTimeout(window.Robot3DViewer.onWindowResize, 100);
                    }
                }
            }
        });
    }
    
    // 暴露给全局
    window.Robot3DViewer = window.Robot3DViewer || {};
    window.Robot3DViewer.addRobot3DSidebar = addRobot3DSidebar;
})();
</script>

<!-- 主入口模块 -->
<script type="text/javascript">
// Robot 3D Viewer - Main Entry Point
// 测试自动构建功能
(function() {
    "use strict";
    
    // 等待 RED 对象完全加载
    function waitForRED(callback) {
        if (typeof RED !== 'undefined' && RED.actions && RED.sidebar && RED.events) {
            callback();
        } else {
            setTimeout(function() { waitForRED(callback); }, 100);
        }
    }
    
    // 主初始化函数
    function mainInit() {
        console.log("DEBUG: Starting Robot 3D Viewer initialization");
        
        window.Robot3DViewer.addRobot3DSidebar();
        window.Robot3DViewer.setupEventListeners();
        
        window.Robot3DViewer.loadDependencies(function() {
            // 所有脚本加载成功后的回调
            // 只有当侧边栏可见时才初始化场景
            if ($('#robot-3d-container').is(':visible')) {
                window.Robot3DViewer.initThreeJSScene();
            }
        });
    }
    
    // 启动逻辑
    waitForRED(mainInit);
    
    // Node-RED 节点注册
    RED.nodes.registerType('robot-3d-viewer', {
        category: 'config',
        color: '#a6bbcf',
        defaults: {
            name: {value: ""}
        },
        inputs: 0,
        outputs: 0,
        icon: "font-awesome/fa-cube",
        label: function() {
            return this.name || "robot 3d viewer";
        }
    });

    // 暴露简易全局 API (可在浏览器控制台或其他脚本中调用)
    window.Robot3DViewerAPI = {
        addJointAnnotation: function(name, temp){ 
            window.Robot3DViewer.addJointAnnotation(name, temp); 
        },
        updateJointTemperature: function(name, temp){ 
            window.Robot3DViewer.updateJointTemperature(name, temp); 
        },
        _debugListJoints: function(){
            if(!window.Robot3DViewer.currentModel){ 
                console.warn('Model not ready'); 
                return; 
            }
            const list = [];
            window.Robot3DViewer.currentModel.traverse(o=>{ 
                if(o.name) list.push(o.name); 
            });
            console.log('Joints / Object names:', list);
            return list;
        }
    };
})();
</script>
