<script type="text/html" data-template-name="robot-3d-viewer">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> åç§°</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-tips">
        <b>æç¤º:</b> è¿™ä¸ªèŠ‚ç‚¹ç”¨äºåŠ è½½æœºå™¨äºº3DæŸ¥çœ‹å™¨åˆ°ä¾§è¾¹æ ã€‚
    </div>
</script>

<style>
/* Robot 3D Viewer æ ·å¼ */
.robot-3d-viewer-panel {
    font-family: Arial, sans-serif;
}

.robot-3d-viewer-panel h3 {
    border-bottom: 2px solid #0077be;
    padding-bottom: 8px;
}

.viewer-controls {
    border: 1px solid #ddd;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.viewer-controls label {
    font-weight: bold;
    color: #495057;
}

.viewer-controls select {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
}

.toggle-btn.active {
    transform: scale(0.95);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

#robot-3d-container {
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    transition: border-color 0.3s ease;
}

#robot-3d-container:hover {
    border-color: #0077be;
}

.viewer-info {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #ddd;
    font-family: 'Courier New', monospace;
}

#loading-indicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

canvas {
    display: block;
    outline: none;
    cursor: grab;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
}

canvas:active {
    cursor: grabbing;
}

/* é˜²æ­¢3Då®¹å™¨å†…çš„æ–‡æœ¬é€‰æ‹©å’Œå³é”®èœå• */
#robot-3d-container {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
}
</style>

<script type="text/javascript">
    (function() {
        "use strict";
        console.log("DEBUG: Robot 3D Viewer initializing");
        
        // ç­‰å¾… RED å¯¹è±¡å®Œå…¨åŠ è½½
        function waitForRED(callback) {
            if (typeof RED !== 'undefined' && RED.actions && RED.sidebar && RED.events) {
                callback();
            } else {
                setTimeout(function() { waitForRED(callback); }, 100);
            }
        }
        
        // Three.js åº“åŠ è½½çŠ¶æ€
        let isThreeJSLoaded = false;
        
        // åŠ¨æ€åŠ è½½ Three.js (å¤šä¸ªCDNå¤‡é€‰)
        function loadThreeJS(callback) {
            if (window.THREE) {
                isThreeJSLoaded = true;
                callback();
                return;
            }
            
            console.log("DEBUG: Loading Three.js library");
            
            // å¤šä¸ªCDNæºåˆ—è¡¨
            const cdnUrls = [
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r156/three.min.js',
                'https://unpkg.com/three@0.156.1/build/three.min.js',
                'https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.min.js',
                'https://threejs.org/build/three.min.js',
                './static/three.min.js'  // æœ¬åœ°å¤‡é€‰
            ];
            
            let currentIndex = 0;
            
            function tryLoadFromCDN() {
                if (currentIndex >= cdnUrls.length) {
                    console.error("All sources failed, using fallback display");
                    loadLocalThreeJS(callback);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdnUrls[currentIndex];
                
                script.onload = function() {
                    console.log("DEBUG: Three.js loaded successfully from:", cdnUrls[currentIndex]);
                    isThreeJSLoaded = true;
                    callback();
                };
                
                script.onerror = function() {
                    console.warn("Failed to load from:", cdnUrls[currentIndex]);
                    currentIndex++;
                    setTimeout(tryLoadFromCDN, 100); // å»¶è¿Ÿé‡è¯•
                };
                
                document.head.appendChild(script);
            }
            
            tryLoadFromCDN();
        }
        
        // æœ¬åœ°Three.jså¤‡é€‰æ–¹æ¡ˆ
        function loadLocalThreeJS(callback) {
            console.log("DEBUG: Trying to create basic 3D scene without Three.js");
            
            // åˆ›å»ºç®€åŒ–çš„3Dæ˜¾ç¤º(ä¸ä¾èµ–Three.js)
            createFallbackDisplay();
            
            RED.notify("Three.jsåº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–æ˜¾ç¤ºæ¨¡å¼", { 
                type: "warning", 
                timeout: 5000 
            });
        }
        
        // å¤‡é€‰æ˜¾ç¤ºæ–¹æ¡ˆ(ä¸ä½¿ç”¨Three.js)
        function createFallbackDisplay() {
            const container = document.getElementById('robot-3d-container');
            if (!container) return;
            
            $('#loading-indicator').hide();
            
            // åˆ›å»ºç®€å•çš„2Dæœºå™¨äººå›¾å½¢è¡¨ç¤º
            const fallbackContent = $(`
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: white;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤–</div>
                    <div style="text-align: center; font-family: Arial;">
                        <h4 style="color: #0077be; margin-bottom: 10px;">æœºå™¨äººæ¨¡å‹é¢„è§ˆ</h4>
                        <p style="font-size: 14px; color: #ccc;">Three.jsåº“æš‚æ—¶ä¸å¯ç”¨</p>
                        <p style="font-size: 12px; color: #999;">ä½¿ç”¨ç®€åŒ–æ˜¾ç¤ºæ¨¡å¼</p>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; border: 1px solid #555; border-radius: 8px; background: rgba(255,255,255,0.1);">
                        <div style="font-size: 12px; color: #bbb; text-align: center;">
                            <div>æ¨¡å‹ç±»å‹: <span id="fallback-model-type">æœºå™¨äºº</span></div>
                            <div>çŠ¶æ€: å¾…åŠ è½½</div>
                        </div>
                    </div>
                </div>
            `);
            
            $(container).empty().append(fallbackContent);
            
            // ç»‘å®šç®€åŒ–çš„æ§ä»¶
            bindFallbackControls();
        }
        
        // ç»‘å®šå¤‡é€‰æ¨¡å¼çš„æ§ä»¶
        function bindFallbackControls() {
            $('#model-selector').off('change').on('change', function() {
                const modelType = $(this).val();
                $('#fallback-model-type').text({
                    'robot': 'æœºå™¨äºº',
                    'cube': 'ç«‹æ–¹ä½“', 
                    'sphere': 'çƒä½“',
                    'cylinder': 'åœ†æŸ±ä½“'
                }[modelType] || 'æœªçŸ¥');
            });
            
            // ç¦ç”¨å…¶ä»–æ§ä»¶
            $('#rotate-btn, #wireframe-btn, #reset-camera-btn').prop('disabled', true).css('opacity', '0.5');
        }
        
        // ä¸»åˆå§‹åŒ–å‡½æ•°
        function initRobot3DViewer() {
            console.log("DEBUG: Initializing Robot 3D Viewer");
            
            // å…ˆåŠ è½½ Three.jsï¼Œç„¶ååˆå§‹åŒ–3DæŸ¥çœ‹å™¨
            loadThreeJS(function() {
                // 1. æ·»åŠ 3DæŸ¥çœ‹å™¨ä¾§è¾¹æ 
                addRobot3DSidebar();
                
                // 2. ç›‘å¬ç¼–è¾‘å™¨äº‹ä»¶
                setupEventListeners();
                
                console.log("DEBUG: Robot 3D Viewer initialized successfully");
            });
        }
        
        // æ·»åŠ æœºå™¨äºº3DæŸ¥çœ‹å™¨ä¾§è¾¹æ 
        function addRobot3DSidebar() {
            var sidebarContent = $(`
                <div class="robot-3d-viewer-panel" style="padding: 15px; height: 100%; display: flex; flex-direction: column;">
                    <h3 style="margin-top: 0; color: #333; margin-bottom: 15px;">
                        <i class="fa fa-cube" style="margin-right: 8px;"></i>
                        æœºå™¨äºº3Dæ¨¡å‹
                    </h3>
                    
                    <div class="viewer-controls" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #555;">è§†å›¾æ§åˆ¶</span>
                            <button id="reset-camera-btn" class="red-ui-button" style="font-size: 12px; padding: 4px 8px;">
                                <i class="fa fa-refresh"></i> é‡ç½®è§†è§’
                            </button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <button id="rotate-btn" class="red-ui-button toggle-btn" style="flex: 1; margin-right: 5px; font-size: 12px;">
                                <i class="fa fa-repeat"></i> è‡ªåŠ¨æ—‹è½¬
                            </button>
                            <button id="wireframe-btn" class="red-ui-button toggle-btn" style="flex: 1; margin-left: 5px; font-size: 12px;">
                                <i class="fa fa-object-group"></i> çº¿æ¡†æ¨¡å¼
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <label style="font-size: 12px; color: #666;">æ¨¡å‹é€‰æ‹©:</label>
                            <select id="model-selector" style="width: 100%; margin-top: 4px;">
                                <option value="robot">æœºå™¨äººæ¨¡å‹</option>
                                <option value="cube">ç«‹æ–¹ä½“</option>
                                <option value="sphere">çƒä½“</option>
                                <option value="cylinder">åœ†æŸ±ä½“</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="robot-3d-container" style="flex: 1; border: 2px solid #ddd; border-radius: 4px; background: #000; position: relative; min-height: 300px;">
                        <div id="loading-indicator" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                            <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>åŠ è½½3Dæ¨¡å‹ä¸­...</div>
                        </div>
                    </div>
                    
                    <div class="viewer-info" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 11px; color: #666;">
                        <div>é¼ æ ‡å·¦é”®: æ—‹è½¬è§†è§’</div>
                        <div>é¼ æ ‡æ»šè½®: ç¼©æ”¾</div>
                        <div>é¼ æ ‡å³é”®: å¹³ç§»è§†è§’</div>
                    </div>
                </div>
            `);
            
            // æ·»åŠ åˆ°ä¾§è¾¹æ 
            RED.sidebar.addTab({
                id: "robot-3d-viewer",
                label: "3Dæ¨¡å‹",
                name: "æœºå™¨äºº3DæŸ¥çœ‹å™¨",
                iconClass: "fa fa-cube",
                content: sidebarContent,
                enableOnEdit: false,
                onchange: function() {
                    // å½“ä¾§è¾¹æ åˆ‡æ¢åˆ°3DæŸ¥çœ‹å™¨æ—¶ï¼Œåˆå§‹åŒ–3Dåœºæ™¯
                    setTimeout(function() {
                        if ($('#robot-3d-container').is(':visible')) {
                            initThreeJSScene();
                        }
                    }, 100);
                }
            });
            
            console.log("DEBUG: Robot 3D viewer sidebar added");
        }
        
        // 3Dåœºæ™¯ç›¸å…³å˜é‡
        let scene, camera, renderer, controls;
        let currentModel = null;
        let animationId = null;
        let autoRotate = false;
        let wireframeMode = false;
        
        // åˆå§‹åŒ–Three.jsåœºæ™¯
        function initThreeJSScene() {
            const container = document.getElementById('robot-3d-container');
            if (!container || !isThreeJSLoaded) {
                console.log("DEBUG: Container not ready or Three.js not loaded");
                return;
            }
            
            // æ¸…é™¤åŠ è½½æŒ‡ç¤ºå™¨
            $('#loading-indicator').hide();
            
            // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œæ¸…ç†æ—§çš„åœºæ™¯
            if (renderer) {
                container.removeChild(renderer.domElement);
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            }
            
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);
            
            // åˆ›å»ºç›¸æœº
            const containerRect = container.getBoundingClientRect();
            camera = new THREE.PerspectiveCamera(75, containerRect.width / containerRect.height, 0.1, 1000);
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(containerRect.width, containerRect.height);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„é¼ æ ‡äº‹ä»¶
            const canvas = renderer.domElement;
            canvas.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
            
            canvas.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            canvas.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            // æ·»åŠ è½¨é“æ§åˆ¶å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (THREE.OrbitControls) {
                controls = new THREE.OrbitControls(camera, canvas);
                controls.enableDamping = true;
                controls.dampingFactor = 0.25;
                controls.enablePan = true;
                controls.enableZoom = true;
                controls.enableRotate = true;
                
                // è‡ªå®šä¹‰é¼ æ ‡æŒ‰é”®æ˜ å°„
                controls.mouseButtons = {
                    LEFT: THREE.MOUSE.ROTATE,
                    MIDDLE: THREE.MOUSE.DOLLY,
                    RIGHT: THREE.MOUSE.PAN
                };
                
                // è§¦æ§è®¾å¤‡æ”¯æŒ
                controls.touches = {
                    ONE: THREE.TOUCH.ROTATE,
                    TWO: THREE.TOUCH.DOLLY_PAN
                };
                
                console.log("DEBUG: OrbitControls configured with custom mouse mapping");
            } else {
                console.warn("OrbitControls not available, using basic camera");
                // æ‰‹åŠ¨å®ç°åŸºç¡€çš„é¼ æ ‡æ§åˆ¶
                setupBasicMouseControls(canvas);
            }
            
            // æ·»åŠ å…‰æº
            setupLighting();
            
            // åˆ›å»ºåˆå§‹æ¨¡å‹
            createRobotModel();
            
            // ç»‘å®šæ§åˆ¶æŒ‰é’®äº‹ä»¶
            bindControlEvents();
            
            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            animate();
            
            // å¤„ç†çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', onWindowResize);
            
            console.log("DEBUG: Three.js scene initialized with custom mouse controls");
        }
        
        // æ‰‹åŠ¨å®ç°åŸºç¡€é¼ æ ‡æ§åˆ¶ï¼ˆå½“OrbitControlsä¸å¯ç”¨æ—¶ï¼‰
        function setupBasicMouseControls(canvas) {
            let isMouseDown = false;
            let mouseButton = null;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', function(e) {
                e.preventDefault();
                isMouseDown = true;
                mouseButton = e.button;
                previousMousePosition = { x: e.clientX, y: e.clientY };
                canvas.style.cursor = 'grabbing';
            });
            
            canvas.addEventListener('mouseup', function(e) {
                e.preventDefault();
                isMouseDown = false;
                mouseButton = null;
                canvas.style.cursor = 'grab';
            });
            
            canvas.addEventListener('mousemove', function(e) {
                if (!isMouseDown) return;
                e.preventDefault();
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                if (mouseButton === 0) { // å·¦é”®æ—‹è½¬
                    if (currentModel) {
                        currentModel.rotation.y += deltaX * 0.01;
                        currentModel.rotation.x += deltaY * 0.01;
                    }
                } else if (mouseButton === 2) { // å³é”®å¹³ç§»
                    camera.position.x -= deltaX * 0.01;
                    camera.position.y += deltaY * 0.01;
                }
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 1.1 : 0.9;
                camera.position.multiplyScalar(delta);
            });
            
            console.log("DEBUG: Basic mouse controls setup complete");
        }
        
        // è®¾ç½®å…‰æº
        function setupLighting() {
            // ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            // ä¸»å…‰æº
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);
            
            // è¡¥å……å…‰æº
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-10, -10, -5);
            scene.add(fillLight);
        }
        
        // åˆ›å»ºæœºå™¨äººæ¨¡å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function createRobotModel() {
            // æ¸…é™¤æ—§æ¨¡å‹
            if (currentModel) {
                scene.remove(currentModel);
            }
            
            const selectedModel = $('#model-selector').val() || 'robot';
            
            switch (selectedModel) {
                case 'robot':
                    currentModel = createSimpleRobot();
                    break;
                case 'cube':
                    currentModel = createCube();
                    break;
                case 'sphere':
                    currentModel = createSphere();
                    break;
                case 'cylinder':
                    currentModel = createCylinder();
                    break;
                default:
                    currentModel = createSimpleRobot();
            }
            
            scene.add(currentModel);
            console.log("DEBUG: Model created:", selectedModel);
        }
        
        // åˆ›å»ºç®€å•çš„æœºå™¨äººæ¨¡å‹
        function createSimpleRobot() {
            const robot = new THREE.Group();
            
            // èº«ä½“
            const bodyGeometry = new THREE.BoxGeometry(1, 1.5, 0.5);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x0077be });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0;
            body.castShadow = true;
            robot.add(body);
            
            // å¤´éƒ¨
            const headGeometry = new THREE.SphereGeometry(0.4);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xcccccc });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.2;
            head.castShadow = true;
            robot.add(head);
            
            // çœ¼ç›
            const eyeGeometry = new THREE.SphereGeometry(0.08);
            const eyeMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.15, 1.3, 0.35);
            robot.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.15, 1.3, 0.35);
            robot.add(rightEye);
            
            // æ‰‹è‡‚
            const armGeometry = new THREE.BoxGeometry(0.3, 1, 0.3);
            const armMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.8, 0.2, 0);
            leftArm.castShadow = true;
            robot.add(leftArm);
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.8, 0.2, 0);
            rightArm.castShadow = true;
            robot.add(rightArm);
            
            // è…¿éƒ¨
            const legGeometry = new THREE.BoxGeometry(0.3, 1.2, 0.3);
            const legMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.3, -1.35, 0);
            leftLeg.castShadow = true;
            robot.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.3, -1.35, 0);
            rightLeg.castShadow = true;
            robot.add(rightLeg);
            
            // æ·»åŠ åœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(10, 10);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2;
            ground.receiveShadow = true;
            robot.add(ground);
            
            return robot;
        }
        
        // åˆ›å»ºç«‹æ–¹ä½“
        function createCube() {
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshLambertMaterial({ color: 0x00ff00 });
            const cube = new THREE.Mesh(geometry, material);
            cube.castShadow = true;
            return cube;
        }
        
        // åˆ›å»ºçƒä½“
        function createSphere() {
            const geometry = new THREE.SphereGeometry(1.5, 32, 32);
            const material = new THREE.MeshLambertMaterial({ color: 0xff0000 });
            const sphere = new THREE.Mesh(geometry, material);
            sphere.castShadow = true;
            return sphere;
        }
        
        // åˆ›å»ºåœ†æŸ±ä½“
        function createCylinder() {
            const geometry = new THREE.CylinderGeometry(1, 1, 3, 32);
            const material = new THREE.MeshLambertMaterial({ color: 0x0000ff });
            const cylinder = new THREE.Mesh(geometry, material);
            cylinder.castShadow = true;
            return cylinder;
        }
        
        // ç»‘å®šæ§åˆ¶æŒ‰é’®äº‹ä»¶
        function bindControlEvents() {
            // é‡ç½®ç›¸æœºæŒ‰é’®
            $('#reset-camera-btn').off('click').on('click', function() {
                camera.position.set(5, 5, 5);
                camera.lookAt(0, 0, 0);
                if (controls) {
                    controls.reset();
                }
            });
            
            // è‡ªåŠ¨æ—‹è½¬æŒ‰é’®
            $('#rotate-btn').off('click').on('click', function() {
                autoRotate = !autoRotate;
                $(this).toggleClass('active', autoRotate);
                if (autoRotate) {
                    $(this).css('background-color', '#28a745');
                } else {
                    $(this).css('background-color', '');
                }
            });
            
            // çº¿æ¡†æ¨¡å¼æŒ‰é’®
            $('#wireframe-btn').off('click').on('click', function() {
                wireframeMode = !wireframeMode;
                $(this).toggleClass('active', wireframeMode);
                if (wireframeMode) {
                    $(this).css('background-color', '#ffc107');
                } else {
                    $(this).css('background-color', '');
                }
                
                // åˆ‡æ¢æ‰€æœ‰ç½‘æ ¼çš„çº¿æ¡†æ¨¡å¼
                scene.traverse(function(object) {
                    if (object.isMesh && object.material) {
                        object.material.wireframe = wireframeMode;
                    }
                });
            });
            
            // æ¨¡å‹é€‰æ‹©å™¨
            $('#model-selector').off('change').on('change', function() {
                createRobotModel();
            });
        }
        
        // åŠ¨ç”»å¾ªç¯
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // è‡ªåŠ¨æ—‹è½¬
            if (autoRotate && currentModel) {
                currentModel.rotation.y += 0.01;
            }
            
            // æ›´æ–°æ§åˆ¶å™¨
            if (controls) {
                controls.update();
            }
            
            // æ¸²æŸ“åœºæ™¯
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // çª—å£å¤§å°å˜åŒ–å¤„ç†
        function onWindowResize() {
            const container = document.getElementById('robot-3d-container');
            if (!container || !camera || !renderer) return;
            
            const containerRect = container.getBoundingClientRect();
            camera.aspect = containerRect.width / containerRect.height;
            camera.updateProjectionMatrix();
            renderer.setSize(containerRect.width, containerRect.height);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç›‘å¬ä¾§è¾¹æ åˆ‡æ¢
            RED.events.on("sidebar:resize", function() {
                setTimeout(onWindowResize, 100);
            });
            
            console.log("DEBUG: Event listeners setup complete");
        }
        
        // å¯åŠ¨åˆå§‹åŒ–
        waitForRED(function() {
            console.log("DEBUG: Starting Robot 3D Viewer initialization");
            
            // æ·»åŠ ä¾§è¾¹æ ï¼ˆæ— è®ºThree.jsæ˜¯å¦åŠ è½½æˆåŠŸï¼‰
            addRobot3DSidebar();
            setupEventListeners();
            
            // å°è¯•åŠ è½½Three.jså’ŒOrbitControls
            loadThreeJS(function() {
                if (window.THREE) {
                    loadOrbitControls(function() {
                        console.log("DEBUG: All libraries loaded, initializing 3D scene");
                        // å½“ä¾§è¾¹æ æ¿€æ´»æ—¶åˆå§‹åŒ–3Dåœºæ™¯
                        setTimeout(function() {
                            if ($('#robot-3d-container').is(':visible')) {
                                initThreeJSScene();
                            }
                        }, 100);
                    });
                }
            });
        });
        
        // åŠ è½½OrbitControls
        function loadOrbitControls(callback) {
            if (window.THREE && THREE.OrbitControls) {
                callback();
                return;
            }
            
            if (!window.THREE) {
                console.warn("Three.js not available, skipping OrbitControls");
                callback();
                return;
            }
            
            const controlsUrls = [
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r156/controls/OrbitControls.js',
                'https://unpkg.com/three@0.156.1/examples/js/controls/OrbitControls.js',
                'https://threejs.org/examples/js/controls/OrbitControls.js'
            ];
            
            let controlIndex = 0;
            
            function tryLoadControls() {
                if (controlIndex >= controlsUrls.length) {
                    console.warn("OrbitControls load failed, using basic camera");
                    callback();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = controlsUrls[controlIndex];
                
                script.onload = function() {
                    console.log("DEBUG: OrbitControls loaded from:", controlsUrls[controlIndex]);
                    callback();
                };
                
                script.onerror = function() {
                    console.warn("Failed to load OrbitControls from:", controlsUrls[controlIndex]);
                    controlIndex++;
                    setTimeout(tryLoadControls, 100);
                };
                
                document.head.appendChild(script);
            }
            
            tryLoadControls();
        }
        
    })();

    // æ³¨å†ŒèŠ‚ç‚¹ç±»å‹ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
    RED.nodes.registerType('robot-3d-viewer', {
        category: 'config',
        color: '#a6bbcf',
        defaults: {
            name: {value: ""}
        },
        inputs: 0,
        outputs: 0,
        icon: "font-awesome/fa-cube",
        label: function() {
            return this.name || "robot 3d viewer";
        }
    });
</script>
