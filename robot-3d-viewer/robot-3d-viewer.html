<script type="text/html" data-template-name="robot-3d-viewer">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-tips">
        <b>提示:</b> 这个节点用于加载机器人3D查看器到侧边栏。
    </div>
</script>

<style>
/* Robot 3D Viewer 样式 */
.robot-3d-viewer-panel {
    font-family: Arial, sans-serif;
}

.robot-3d-viewer-panel h3 {
    border-bottom: 2px solid #0077be;
    padding-bottom: 8px;
}

.viewer-controls {
    border: 1px solid #ddd;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.viewer-controls label {
    font-weight: bold;
    color: #495057;
}

.viewer-controls select {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 12px;
}

.toggle-btn.active {
    transform: scale(0.95);
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

#robot-3d-container {
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    transition: border-color 0.3s ease;
}

#robot-3d-container:hover {
    border-color: #0077be;
}

.viewer-info {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #ddd;
    font-family: 'Courier New', monospace;
}

#loading-indicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 0.5; }
    50% { opacity: 1; }
    100% { opacity: 0.5; }
}

canvas {
    display: block;
    outline: none;
    cursor: grab;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
}

canvas:active {
    cursor: grabbing;
}

/* 防止3D容器内的文本选择和右键菜单 */
#robot-3d-container {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-touch-callout: none;
}
</style>

<script type="text/javascript">
    (function() {
        "use strict";
        console.log("DEBUG: Robot 3D Viewer initializing");
        
        // 等待 RED 对象完全加载
        function waitForRED(callback) {
            if (typeof RED !== 'undefined' && RED.actions && RED.sidebar && RED.events) {
                callback();
            } else {
                setTimeout(function() { waitForRED(callback); }, 100);
            }
        }
        
        // Three.js 库加载状态
        let isThreeJSLoaded = false;
        
        // 动态加载 Three.js (多个CDN备选)
        function loadThreeJS(callback) {
            if (window.THREE) {
                isThreeJSLoaded = true;
                callback();
                return;
            }
            
            console.log("DEBUG: Loading Three.js library");
            
            // 多个CDN源列表
            const cdnUrls = [
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r156/three.min.js',
                'https://unpkg.com/three@0.156.1/build/three.min.js',
                'https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.min.js',
                'https://threejs.org/build/three.min.js',
                './static/three.min.js'  // 本地备选
            ];
            
            let currentIndex = 0;
            
            function tryLoadFromCDN() {
                if (currentIndex >= cdnUrls.length) {
                    console.error("All sources failed, using fallback display");
                    loadLocalThreeJS(callback);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdnUrls[currentIndex];
                
                script.onload = function() {
                    console.log("DEBUG: Three.js loaded successfully from:", cdnUrls[currentIndex]);
                    isThreeJSLoaded = true;
                    callback();
                };
                
                script.onerror = function() {
                    console.warn("Failed to load from:", cdnUrls[currentIndex]);
                    currentIndex++;
                    setTimeout(tryLoadFromCDN, 100); // 延迟重试
                };
                
                document.head.appendChild(script);
            }
            
            tryLoadFromCDN();
        }
        
        // 本地Three.js备选方案
        function loadLocalThreeJS(callback) {
            console.log("DEBUG: Trying to create basic 3D scene without Three.js");
            
            // 创建简化的3D显示(不依赖Three.js)
            createFallbackDisplay();
            
            RED.notify("Three.js库加载失败，使用简化显示模式", { 
                type: "warning", 
                timeout: 5000 
            });
        }
        
        // 备选显示方案(不使用Three.js)
        function createFallbackDisplay() {
            const container = document.getElementById('robot-3d-container');
            if (!container) return;
            
            $('#loading-indicator').hide();
            
            // 创建简单的2D机器人图形表示
            const fallbackContent = $(`
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: white;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🤖</div>
                    <div style="text-align: center; font-family: Arial;">
                        <h4 style="color: #0077be; margin-bottom: 10px;">机器人模型预览</h4>
                        <p style="font-size: 14px; color: #ccc;">Three.js库暂时不可用</p>
                        <p style="font-size: 12px; color: #999;">使用简化显示模式</p>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; border: 1px solid #555; border-radius: 8px; background: rgba(255,255,255,0.1);">
                        <div style="font-size: 12px; color: #bbb; text-align: center;">
                            <div>模型类型: <span id="fallback-model-type">机器人</span></div>
                            <div>状态: 待加载</div>
                        </div>
                    </div>
                </div>
            `);
            
            $(container).empty().append(fallbackContent);
            
            // 绑定简化的控件
            bindFallbackControls();
        }
        
        // 绑定备选模式的控件
        function bindFallbackControls() {
            $('#model-selector').off('change').on('change', function() {
                const modelType = $(this).val();
                $('#fallback-model-type').text({
                    'robot': '机器人',
                    'cube': '立方体', 
                    'sphere': '球体',
                    'cylinder': '圆柱体'
                }[modelType] || '未知');
            });
            
            // 禁用其他控件
            $('#rotate-btn, #wireframe-btn, #reset-camera-btn').prop('disabled', true).css('opacity', '0.5');
        }
        
        // 主初始化函数
        function initRobot3DViewer() {
            console.log("DEBUG: Initializing Robot 3D Viewer");
            
            // 先加载 Three.js，然后初始化3D查看器
            loadThreeJS(function() {
                // 1. 添加3D查看器侧边栏
                addRobot3DSidebar();
                
                // 2. 监听编辑器事件
                setupEventListeners();
                
                console.log("DEBUG: Robot 3D Viewer initialized successfully");
            });
        }
        
        // 添加机器人3D查看器侧边栏
        function addRobot3DSidebar() {
            var sidebarContent = $(`
                <div class="robot-3d-viewer-panel" style="padding: 15px; height: 100%; display: flex; flex-direction: column;">
                    <h3 style="margin-top: 0; color: #333; margin-bottom: 15px;">
                        <i class="fa fa-cube" style="margin-right: 8px;"></i>
                        机器人3D模型
                    </h3>
                    
                    <div class="viewer-controls" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: #555;">视图控制</span>
                            <button id="reset-camera-btn" class="red-ui-button" style="font-size: 12px; padding: 4px 8px;">
                                <i class="fa fa-refresh"></i> 重置视角
                            </button>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <button id="rotate-btn" class="red-ui-button toggle-btn" style="flex: 1; margin-right: 5px; font-size: 12px;">
                                <i class="fa fa-repeat"></i> 自动旋转
                            </button>
                            <button id="wireframe-btn" class="red-ui-button toggle-btn" style="flex: 1; margin-left: 5px; font-size: 12px;">
                                <i class="fa fa-object-group"></i> 线框模式
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <label style="font-size: 12px; color: #666;">模型选择:</label>
                            <select id="model-selector" style="width: 100%; margin-top: 4px;">
                                <option value="robot">机器人模型</option>
                                <option value="cube">立方体</option>
                                <option value="sphere">球体</option>
                                <option value="cylinder">圆柱体</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="robot-3d-container" style="flex: 1; border: 2px solid #ddd; border-radius: 4px; background: #000; position: relative; min-height: 300px;">
                        <div id="loading-indicator" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center;">
                            <i class="fa fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <div>加载3D模型中...</div>
                        </div>
                    </div>
                    
                    <div class="viewer-info" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 11px; color: #666;">
                        <div>鼠标左键: 旋转视角</div>
                        <div>鼠标滚轮: 缩放</div>
                        <div>鼠标右键: 平移视角</div>
                    </div>
                </div>
            `);
            
            // 添加到侧边栏
            RED.sidebar.addTab({
                id: "robot-3d-viewer",
                label: "3D模型",
                name: "机器人3D查看器",
                iconClass: "fa fa-cube",
                content: sidebarContent,
                enableOnEdit: false,
                onchange: function() {
                    // 当侧边栏切换到3D查看器时，初始化3D场景
                    setTimeout(function() {
                        if ($('#robot-3d-container').is(':visible')) {
                            initThreeJSScene();
                        }
                    }, 100);
                }
            });
            
            console.log("DEBUG: Robot 3D viewer sidebar added");
        }
        
        // 3D场景相关变量
        let scene, camera, renderer, controls;
        let currentModel = null;
        let animationId = null;
        let autoRotate = false;
        let wireframeMode = false;
        
        // 初始化Three.js场景
        function initThreeJSScene() {
            const container = document.getElementById('robot-3d-container');
            if (!container || !isThreeJSLoaded) {
                console.log("DEBUG: Container not ready or Three.js not loaded");
                return;
            }
            
            // 清除加载指示器
            $('#loading-indicator').hide();
            
            // 如果已经初始化过，清理旧的场景
            if (renderer) {
                container.removeChild(renderer.domElement);
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            }
            
            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);
            
            // 创建相机
            const containerRect = container.getBoundingClientRect();
            camera = new THREE.PerspectiveCamera(75, containerRect.width / containerRect.height, 0.1, 1000);
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
            
            // 创建渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(containerRect.width, containerRect.height);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            // 阻止浏览器默认的鼠标事件
            const canvas = renderer.domElement;
            canvas.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
            
            canvas.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            canvas.addEventListener('dragstart', function(e) {
                e.preventDefault();
                return false;
            });
            
            // 添加轨道控制器（如果可用）
            if (THREE.OrbitControls) {
                controls = new THREE.OrbitControls(camera, canvas);
                controls.enableDamping = true;
                controls.dampingFactor = 0.25;
                controls.enablePan = true;
                controls.enableZoom = true;
                controls.enableRotate = true;
                
                // 自定义鼠标按键映射
                controls.mouseButtons = {
                    LEFT: THREE.MOUSE.ROTATE,
                    MIDDLE: THREE.MOUSE.DOLLY,
                    RIGHT: THREE.MOUSE.PAN
                };
                
                // 触控设备支持
                controls.touches = {
                    ONE: THREE.TOUCH.ROTATE,
                    TWO: THREE.TOUCH.DOLLY_PAN
                };
                
                console.log("DEBUG: OrbitControls configured with custom mouse mapping");
            } else {
                console.warn("OrbitControls not available, using basic camera");
                // 手动实现基础的鼠标控制
                setupBasicMouseControls(canvas);
            }
            
            // 添加光源
            setupLighting();
            
            // 创建初始模型
            createRobotModel();
            
            // 绑定控制按钮事件
            bindControlEvents();
            
            // 开始渲染循环
            animate();
            
            // 处理窗口大小变化
            window.addEventListener('resize', onWindowResize);
            
            console.log("DEBUG: Three.js scene initialized with custom mouse controls");
        }
        
        // 手动实现基础鼠标控制（当OrbitControls不可用时）
        function setupBasicMouseControls(canvas) {
            let isMouseDown = false;
            let mouseButton = null;
            let previousMousePosition = { x: 0, y: 0 };
            
            canvas.addEventListener('mousedown', function(e) {
                e.preventDefault();
                isMouseDown = true;
                mouseButton = e.button;
                previousMousePosition = { x: e.clientX, y: e.clientY };
                canvas.style.cursor = 'grabbing';
            });
            
            canvas.addEventListener('mouseup', function(e) {
                e.preventDefault();
                isMouseDown = false;
                mouseButton = null;
                canvas.style.cursor = 'grab';
            });
            
            canvas.addEventListener('mousemove', function(e) {
                if (!isMouseDown) return;
                e.preventDefault();
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;
                
                if (mouseButton === 0) { // 左键旋转
                    if (currentModel) {
                        currentModel.rotation.y += deltaX * 0.01;
                        currentModel.rotation.x += deltaY * 0.01;
                    }
                } else if (mouseButton === 2) { // 右键平移
                    camera.position.x -= deltaX * 0.01;
                    camera.position.y += deltaY * 0.01;
                }
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });
            
            canvas.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 1.1 : 0.9;
                camera.position.multiplyScalar(delta);
            });
            
            console.log("DEBUG: Basic mouse controls setup complete");
        }
        
        // 设置光源
        function setupLighting() {
            // 环境光
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            // 主光源
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);
            
            // 补充光源
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-10, -10, -5);
            scene.add(fillLight);
        }
        
        // 创建机器人模型（简化版）
        function createRobotModel() {
            // 清除旧模型
            if (currentModel) {
                scene.remove(currentModel);
            }
            
            const selectedModel = $('#model-selector').val() || 'robot';
            
            switch (selectedModel) {
                case 'robot':
                    currentModel = createSimpleRobot();
                    break;
                case 'cube':
                    currentModel = createCube();
                    break;
                case 'sphere':
                    currentModel = createSphere();
                    break;
                case 'cylinder':
                    currentModel = createCylinder();
                    break;
                default:
                    currentModel = createSimpleRobot();
            }
            
            scene.add(currentModel);
            console.log("DEBUG: Model created:", selectedModel);
        }
        
        // 创建简单的机器人模型
        function createSimpleRobot() {
            const robot = new THREE.Group();
            
            // 身体
            const bodyGeometry = new THREE.BoxGeometry(1, 1.5, 0.5);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0x0077be });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0;
            body.castShadow = true;
            robot.add(body);
            
            // 头部
            const headGeometry = new THREE.SphereGeometry(0.4);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xcccccc });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.2;
            head.castShadow = true;
            robot.add(head);
            
            // 眼睛
            const eyeGeometry = new THREE.SphereGeometry(0.08);
            const eyeMaterial = new THREE.MeshLambertMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.15, 1.3, 0.35);
            robot.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.15, 1.3, 0.35);
            robot.add(rightEye);
            
            // 手臂
            const armGeometry = new THREE.BoxGeometry(0.3, 1, 0.3);
            const armMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.8, 0.2, 0);
            leftArm.castShadow = true;
            robot.add(leftArm);
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.8, 0.2, 0);
            rightArm.castShadow = true;
            robot.add(rightArm);
            
            // 腿部
            const legGeometry = new THREE.BoxGeometry(0.3, 1.2, 0.3);
            const legMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.3, -1.35, 0);
            leftLeg.castShadow = true;
            robot.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.3, -1.35, 0);
            rightLeg.castShadow = true;
            robot.add(rightLeg);
            
            // 添加地面
            const groundGeometry = new THREE.PlaneGeometry(10, 10);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2;
            ground.receiveShadow = true;
            robot.add(ground);
            
            return robot;
        }
        
        // 创建立方体
        function createCube() {
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshLambertMaterial({ color: 0x00ff00 });
            const cube = new THREE.Mesh(geometry, material);
            cube.castShadow = true;
            return cube;
        }
        
        // 创建球体
        function createSphere() {
            const geometry = new THREE.SphereGeometry(1.5, 32, 32);
            const material = new THREE.MeshLambertMaterial({ color: 0xff0000 });
            const sphere = new THREE.Mesh(geometry, material);
            sphere.castShadow = true;
            return sphere;
        }
        
        // 创建圆柱体
        function createCylinder() {
            const geometry = new THREE.CylinderGeometry(1, 1, 3, 32);
            const material = new THREE.MeshLambertMaterial({ color: 0x0000ff });
            const cylinder = new THREE.Mesh(geometry, material);
            cylinder.castShadow = true;
            return cylinder;
        }
        
        // 绑定控制按钮事件
        function bindControlEvents() {
            // 重置相机按钮
            $('#reset-camera-btn').off('click').on('click', function() {
                camera.position.set(5, 5, 5);
                camera.lookAt(0, 0, 0);
                if (controls) {
                    controls.reset();
                }
            });
            
            // 自动旋转按钮
            $('#rotate-btn').off('click').on('click', function() {
                autoRotate = !autoRotate;
                $(this).toggleClass('active', autoRotate);
                if (autoRotate) {
                    $(this).css('background-color', '#28a745');
                } else {
                    $(this).css('background-color', '');
                }
            });
            
            // 线框模式按钮
            $('#wireframe-btn').off('click').on('click', function() {
                wireframeMode = !wireframeMode;
                $(this).toggleClass('active', wireframeMode);
                if (wireframeMode) {
                    $(this).css('background-color', '#ffc107');
                } else {
                    $(this).css('background-color', '');
                }
                
                // 切换所有网格的线框模式
                scene.traverse(function(object) {
                    if (object.isMesh && object.material) {
                        object.material.wireframe = wireframeMode;
                    }
                });
            });
            
            // 模型选择器
            $('#model-selector').off('change').on('change', function() {
                createRobotModel();
            });
        }
        
        // 动画循环
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // 自动旋转
            if (autoRotate && currentModel) {
                currentModel.rotation.y += 0.01;
            }
            
            // 更新控制器
            if (controls) {
                controls.update();
            }
            
            // 渲染场景
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // 窗口大小变化处理
        function onWindowResize() {
            const container = document.getElementById('robot-3d-container');
            if (!container || !camera || !renderer) return;
            
            const containerRect = container.getBoundingClientRect();
            camera.aspect = containerRect.width / containerRect.height;
            camera.updateProjectionMatrix();
            renderer.setSize(containerRect.width, containerRect.height);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 监听侧边栏切换
            RED.events.on("sidebar:resize", function() {
                setTimeout(onWindowResize, 100);
            });
            
            console.log("DEBUG: Event listeners setup complete");
        }
        
        // 启动初始化
        waitForRED(function() {
            console.log("DEBUG: Starting Robot 3D Viewer initialization");
            
            // 添加侧边栏（无论Three.js是否加载成功）
            addRobot3DSidebar();
            setupEventListeners();
            
            // 尝试加载Three.js和OrbitControls
            loadThreeJS(function() {
                if (window.THREE) {
                    loadOrbitControls(function() {
                        console.log("DEBUG: All libraries loaded, initializing 3D scene");
                        // 当侧边栏激活时初始化3D场景
                        setTimeout(function() {
                            if ($('#robot-3d-container').is(':visible')) {
                                initThreeJSScene();
                            }
                        }, 100);
                    });
                }
            });
        });
        
        // 加载OrbitControls
        function loadOrbitControls(callback) {
            if (window.THREE && THREE.OrbitControls) {
                callback();
                return;
            }
            
            if (!window.THREE) {
                console.warn("Three.js not available, skipping OrbitControls");
                callback();
                return;
            }
            
            const controlsUrls = [
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r156/controls/OrbitControls.js',
                'https://unpkg.com/three@0.156.1/examples/js/controls/OrbitControls.js',
                'https://threejs.org/examples/js/controls/OrbitControls.js'
            ];
            
            let controlIndex = 0;
            
            function tryLoadControls() {
                if (controlIndex >= controlsUrls.length) {
                    console.warn("OrbitControls load failed, using basic camera");
                    callback();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = controlsUrls[controlIndex];
                
                script.onload = function() {
                    console.log("DEBUG: OrbitControls loaded from:", controlsUrls[controlIndex]);
                    callback();
                };
                
                script.onerror = function() {
                    console.warn("Failed to load OrbitControls from:", controlsUrls[controlIndex]);
                    controlIndex++;
                    setTimeout(tryLoadControls, 100);
                };
                
                document.head.appendChild(script);
            }
            
            tryLoadControls();
        }
        
    })();

    // 注册节点类型（保持兼容性）
    RED.nodes.registerType('robot-3d-viewer', {
        category: 'config',
        color: '#a6bbcf',
        defaults: {
            name: {value: ""}
        },
        inputs: 0,
        outputs: 0,
        icon: "font-awesome/fa-cube",
        label: function() {
            return this.name || "robot 3d viewer";
        }
    });
</script>
