<script type="text/html" data-template-name="humanoid-utils">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> åç§°</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-tips">
        <b>æç¤º:</b> è¿™ä¸ªèŠ‚ç‚¹æœ¬èº«æ²¡æœ‰åŠŸèƒ½ï¼Œä»…ç”¨äºåŠ è½½è‡ªå®šä¹‰çš„UIå…ƒç´ ã€‚
    </div>
</script>


<script type="text/javascript">
    (function() {
        "use strict";
        console.log("DEBUG: Humanoid Robot Utils initializing with official Editor API");
        // ç­‰å¾… RED å¯¹è±¡å®Œå…¨åŠ è½½
        function waitForRED(callback) {
            if (typeof RED !== 'undefined' && RED.actions && RED.sidebar && RED.events) {
                callback();
            } else {
                setTimeout(function() { waitForRED(callback); }, 100);
            }
        }
        
        // ä¸»åˆå§‹åŒ–å‡½æ•°
        function initHumanoidUtils() {
            console.log("DEBUG: Initializing Humanoid Robot Utils with Editor API");
            
            // 1. æ³¨å†Œæ€¥åœåŠ¨ä½œ
            registerEmergencyStopAction();
            
            // 2. æ·»åŠ å·¥å…·æ æŒ‰é’®ï¼ˆä½¿ç”¨å®˜æ–¹æ–¹å¼ï¼‰
            addToolbarButton();
            
            // 3. æ·»åŠ æœºå™¨äººæ§åˆ¶ä¾§è¾¹æ 
            addRobotControlSidebar();
            
            // 4. ç›‘å¬ç¼–è¾‘å™¨äº‹ä»¶
            setupEventListeners();
            
            console.log("DEBUG: Humanoid Robot Utils initialized successfully");
        }
        
        // æ³¨å†Œæ€¥åœåŠ¨ä½œï¼ˆä½¿ç”¨ RED.actions APIï¼‰
        function registerEmergencyStopAction() {
            RED.actions.add("humanoid:emergency-stop", function() {
                console.log("Emergency Stop action triggered");
                
                // æ˜¾ç¤ºæ€¥åœç¡®è®¤å¯¹è¯æ¡†
                var dialog = $('<div title="ç´§æ€¥åœæ­¢ç¡®è®¤">').dialog({
                    modal: true,
                    width: 400,
                    height: 200,
                    resizable: false,
                    close: function() { $(this).dialog('destroy').remove(); },
                    buttons: {
                        "ç¡®è®¤åœæ­¢": function() {
                            performEmergencyStop();
                            $(this).dialog('close');
                        },
                        "å–æ¶ˆ": function() {
                            $(this).dialog('close');
                        }
                    }
                });
                
                dialog.html(`
                    <div style="text-align: center; padding: 20px;">
                        <i class="fa fa-exclamation-triangle" style="color: #c00; font-size: 48px; margin-bottom: 15px;"></i>
                        <p style="font-size: 16px; font-weight: bold;">ç¡®å®šè¦æ‰§è¡Œç´§æ€¥åœæ­¢å—ï¼Ÿ</p>
                        <p style="color: #666;">è¿™å°†ç«‹å³åœæ­¢æ‰€æœ‰æœºå™¨äººè¿åŠ¨</p>
                    </div>
                `);
            });
            
            console.log("DEBUG: Emergency stop action registered");
        }
        
        // æ‰§è¡Œæ€¥åœæ“ä½œ
        function performEmergencyStop() {
            console.log("DEBUG: Performing emergency stop");
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ€¥åœé€»è¾‘
            // ä¾‹å¦‚ï¼šå‘é€ HTTP è¯·æ±‚åˆ°æœºå™¨äººæ§åˆ¶å™¨
            // æˆ–è€…è§¦å‘ç‰¹å®šçš„æµç¨‹èŠ‚ç‚¹
            
            RED.notify("âš ï¸ ç´§æ€¥åœæ­¢å·²æ¿€æ´»ï¼", {
                type: "warning",
                timeout: 5000,
                fixed: true
            });
            
            // å¹¿æ’­æ€¥åœäº‹ä»¶
            RED.events.emit("humanoid:emergency-stop", {
                timestamp: new Date().toISOString(),
                source: "editor-button"
            });
        }
        
        // æ·»åŠ å·¥å…·æ æŒ‰é’®
        function addToolbarButton() {
            if ($('#humanoid-estop-btn').length === 0) {
                var emergencyStopButton = `
                    <button id="humanoid-estop-btn" class="red-ui-button" style="background-color: #c00; color: white; margin-left: 10px; font-weight: bold;">
                        <i class="fa fa-exclamation-triangle"></i>
                        ç´§æ€¥åœæ­¢
                    </button>
                `;

                // è·å–å…ƒç´ å½“å‰å®½åº¦
                //var currentWidth = $('.red-ui-header-toolbar').width();

                // è®¡ç®—å‡å°‘20%åçš„å®½åº¦å¹¶è®¾ç½®
                //$('.red-ui-header-toolbar').width(currentWidth * 1.8);
            
                // å°†æŒ‰é’®æ·»åŠ åˆ°Headerå·¥å…·æ 
                $('#red-ui-workspace .red-ui-header-toolbar').prepend(emergencyStopButton);
                console.log("DEBUG: Emergency Stop button has been injected into the header.");
                $('#humanoid-estop-btn').on('dblclick', function() {
                    RED.actions.invoke("humanoid:emergency-stop");
                });
            } else {
                console.log("DEBUG: Emergency Stop button already exists. Skipping injection.");
            }
        }
        
        // æ·»åŠ æœºå™¨äººæ§åˆ¶ä¾§è¾¹æ ï¼ˆä½¿ç”¨ RED.sidebar APIï¼‰
        function addRobotControlSidebar() {
            var sidebarContent = $(`
                <div class="humanoid-control-panel" style="padding: 15px;">
                    <h3 style="margin-top: 0; color: #333;">
                        <i class="fa fa-android" style="margin-right: 8px;"></i>
                        æœºå™¨äººæ§åˆ¶
                    </h3>
                    
                    <div class="control-section" style="margin-bottom: 20px;">
                        <h4 style="color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                            å®‰å…¨æ§åˆ¶
                        </h4>
                        <button class="red-ui-button emergency-btn" 
                                style="width: 100%; background: #dc3545; color: white; margin-bottom: 10px; font-weight: bold;">
                            <i class="fa fa-hand-stop-o"></i> ç´§æ€¥åœæ­¢
                        </button>
                        <button class="red-ui-button reset-btn" 
                                style="width: 100%; background: #28a745; color: white;">
                            <i class="fa fa-refresh"></i> é‡ç½®ç³»ç»Ÿ
                        </button>
                    </div>
                    
                    <div class="control-section" style="margin-bottom: 20px;">
                        <h4 style="color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                            çŠ¶æ€ç›‘æ§
                        </h4>
                        <div id="robot-status" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                            <div>çŠ¶æ€: <span id="status-text" style="color: #28a745; font-weight: bold;">æ­£å¸¸</span></div>
                            <div>æœ€åæ›´æ–°: <span id="last-update">--</span></div>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h4 style="color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                            äº‹ä»¶æ—¥å¿—
                        </h4>
                        <div id="event-log" style="background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 11px;">
                            <div style="color: #666;">[å¯åŠ¨] æœºå™¨äººæ§åˆ¶é¢æ¿å·²åŠ è½½</div>
                        </div>
                    </div>
                </div>
            `);
            
            // ç»‘å®šä¾§è¾¹æ æŒ‰é’®äº‹ä»¶
            sidebarContent.find('.emergency-btn').on('click', function() {
                RED.actions.invoke("humanoid:emergency-stop");
            });
            
            sidebarContent.find('.reset-btn').on('click', function() {
                RED.actions.invoke("humanoid:reset-system");
            });
            
            // æ³¨å†Œé‡ç½®ç³»ç»ŸåŠ¨ä½œ
            RED.actions.add("humanoid:reset-system", function() {
                console.log("Reset system action triggered");
                RED.notify("ğŸ”„ ç³»ç»Ÿé‡ç½®ä¸­...", { type: "info", timeout: 3000 });
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateRobotStatus("é‡ç½®ä¸­", "warning");
                addEventLog("ç³»ç»Ÿé‡ç½®è¯·æ±‚");
                
                // æ¨¡æ‹Ÿé‡ç½®è¿‡ç¨‹
                setTimeout(function() {
                    updateRobotStatus("æ­£å¸¸", "success");
                    addEventLog("ç³»ç»Ÿé‡ç½®å®Œæˆ");
                    RED.notify("âœ… ç³»ç»Ÿé‡ç½®å®Œæˆ", { type: "success" });
                }, 2000);
            });
            
            // æ·»åŠ åˆ°ä¾§è¾¹æ 
            RED.sidebar.addTab({
                id: "humanoid-control",
                label: "æœºå™¨äºº",
                name: "æœºå™¨äººæ§åˆ¶",
                iconClass: "fa fa-android",
                content: sidebarContent,
                enableOnEdit: false
            });
            
            console.log("DEBUG: Robot control sidebar added");
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨ï¼ˆä½¿ç”¨ RED.events APIï¼‰
        function setupEventListeners() {
            // ç›‘å¬æ€¥åœäº‹ä»¶
            RED.events.on("humanoid:emergency-stop", function(event) {
                console.log("Emergency stop event received:", event);
                updateRobotStatus("æ€¥åœ", "danger");
                addEventLog("ç´§æ€¥åœæ­¢æ¿€æ´» - " + event.source);
            });
            
            // ç›‘å¬éƒ¨ç½²äº‹ä»¶
            RED.events.on("deploy", function() {
                addEventLog("æµç¨‹å·²éƒ¨ç½²");
            });
            
            // ç›‘å¬èŠ‚ç‚¹å˜åŒ–äº‹ä»¶
            RED.events.on("nodes:add", function(node) {
                if (node.type.includes("robot") || node.type.includes("humanoid")) {
                    addEventLog("æ·»åŠ æœºå™¨äººèŠ‚ç‚¹: " + node.type);
                }
            });
            
            console.log("DEBUG: Event listeners setup complete");
        }
        
        // æ›´æ–°æœºå™¨äººçŠ¶æ€æ˜¾ç¤º
        function updateRobotStatus(status, type) {
            var statusElement = $('#status-text');
            var lastUpdateElement = $('#last-update');
            
            if (statusElement.length > 0) {
                statusElement.text(status);
                statusElement.removeClass('text-success text-warning text-danger');
                
                switch(type) {
                    case 'success':
                        statusElement.css('color', '#28a745');
                        break;
                    case 'warning':
                        statusElement.css('color', '#ffc107');
                        break;
                    case 'danger':
                        statusElement.css('color', '#dc3545');
                        break;
                }
            }
            
            if (lastUpdateElement.length > 0) {
                lastUpdateElement.text(new Date().toLocaleTimeString());
            }
        }
        
        // æ·»åŠ äº‹ä»¶æ—¥å¿—
        function addEventLog(message) {
            var logElement = $('#event-log');
            if (logElement.length > 0) {
                var timestamp = new Date().toLocaleTimeString();
                var logEntry = $(`<div style="color: #333; margin-bottom: 2px;">[${timestamp}] ${message}</div>`);
                logElement.append(logEntry);
                
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                logElement.scrollTop(logElement[0].scrollHeight);
                
                // é™åˆ¶æ—¥å¿—æ¡æ•°
                var logs = logElement.children();
                if (logs.length > 50) {
                    logs.first().remove();
                }
            }
        }
        
        // å¯åŠ¨åˆå§‹åŒ–
        waitForRED(initHumanoidUtils);
        
    })();

    // æ³¨å†ŒèŠ‚ç‚¹ç±»å‹ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
    RED.nodes.registerType('humanoid-utils', {
        category: 'config',
        color: '#a6bbcf',
        defaults: {
            name: {value: ""}
        },
        inputs: 0,
        outputs: 0,
        icon: "font-awesome/fa-android",
        label: function() {
            return this.name || "humanoid utils";
        }
    });
</script>