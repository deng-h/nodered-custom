<script type="text/html" data-template-name="humanoid-utils">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-tips">
        <b>提示:</b> 这个节点本身没有功能，仅用于加载自定义的UI元素。
    </div>
</script>


<script type="text/javascript">
    (function() {
        "use strict";
        console.log("DEBUG: Humanoid Robot Utils initializing with official Editor API");
        // 等待 RED 对象完全加载
        function waitForRED(callback) {
            if (typeof RED !== 'undefined' && RED.actions && RED.sidebar && RED.events) {
                callback();
            } else {
                setTimeout(function() { waitForRED(callback); }, 100);
            }
        }
        
        // 主初始化函数
        function initHumanoidUtils() {
            console.log("DEBUG: Initializing Humanoid Robot Utils with Editor API");
            
            // 1. 注册急停动作
            registerEmergencyStopAction();
            
            // 2. 添加工具栏按钮（使用官方方式）
            addToolbarButton();
            
            // 3. 添加机器人控制侧边栏
            addRobotControlSidebar();
            
            // 4. 监听编辑器事件
            setupEventListeners();
            
            console.log("DEBUG: Humanoid Robot Utils initialized successfully");
        }
        
        // 注册急停动作（使用 RED.actions API）
        function registerEmergencyStopAction() {
            RED.actions.add("humanoid:emergency-stop", function() {
                console.log("Emergency Stop action triggered");
                
                // 显示急停确认对话框
                var dialog = $('<div title="紧急停止确认">').dialog({
                    modal: true,
                    width: 400,
                    height: 200,
                    resizable: false,
                    close: function() { $(this).dialog('destroy').remove(); },
                    buttons: {
                        "确认停止": function() {
                            performEmergencyStop();
                            $(this).dialog('close');
                        },
                        "取消": function() {
                            $(this).dialog('close');
                        }
                    }
                });
                
                dialog.html(`
                    <div style="text-align: center; padding: 20px;">
                        <i class="fa fa-exclamation-triangle" style="color: #c00; font-size: 48px; margin-bottom: 15px;"></i>
                        <p style="font-size: 16px; font-weight: bold;">确定要执行紧急停止吗？</p>
                        <p style="color: #666;">这将立即停止所有机器人运动</p>
                    </div>
                `);
            });
            
            console.log("DEBUG: Emergency stop action registered");
        }
        
        // 执行急停操作
        function performEmergencyStop() {
            console.log("DEBUG: Performing emergency stop");
            
            // 这里可以添加实际的急停逻辑
            // 例如：发送 HTTP 请求到机器人控制器
            // 或者触发特定的流程节点
            
            RED.notify("⚠️ 紧急停止已激活！", {
                type: "warning",
                timeout: 5000,
                fixed: true
            });
            
            // 广播急停事件
            RED.events.emit("humanoid:emergency-stop", {
                timestamp: new Date().toISOString(),
                source: "editor-button"
            });
        }
        
        // 添加工具栏按钮
        function addToolbarButton() {
            if ($('#humanoid-estop-btn').length === 0) {
                var emergencyStopButton = `
                    <button id="humanoid-estop-btn" class="red-ui-button" style="background-color: #c00; color: white; margin-left: 10px; font-weight: bold;">
                        <i class="fa fa-exclamation-triangle"></i>
                        紧急停止
                    </button>
                `;

                // 获取元素当前宽度
                //var currentWidth = $('.red-ui-header-toolbar').width();

                // 计算减少20%后的宽度并设置
                //$('.red-ui-header-toolbar').width(currentWidth * 1.8);
            
                // 将按钮添加到Header工具栏
                $('#red-ui-workspace .red-ui-header-toolbar').prepend(emergencyStopButton);
                console.log("DEBUG: Emergency Stop button has been injected into the header.");
                $('#humanoid-estop-btn').on('dblclick', function() {
                    RED.actions.invoke("humanoid:emergency-stop");
                });
            } else {
                console.log("DEBUG: Emergency Stop button already exists. Skipping injection.");
            }
        }
        
        // 添加机器人控制侧边栏（使用 RED.sidebar API）
        function addRobotControlSidebar() {
            var sidebarContent = $(`
                <div class="humanoid-control-panel" style="padding: 15px;">
                    <h3 style="margin-top: 0; color: #333;">
                        <i class="fa fa-android" style="margin-right: 8px;"></i>
                        机器人控制
                    </h3>
                    
                    <div class="control-section" style="margin-bottom: 20px;">
                        <h4 style="color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                            安全控制
                        </h4>
                        <button class="red-ui-button emergency-btn" 
                                style="width: 100%; background: #dc3545; color: white; margin-bottom: 10px; font-weight: bold;">
                            <i class="fa fa-hand-stop-o"></i> 紧急停止
                        </button>
                        <button class="red-ui-button reset-btn" 
                                style="width: 100%; background: #28a745; color: white;">
                            <i class="fa fa-refresh"></i> 重置系统
                        </button>
                    </div>
                    
                    <div class="control-section" style="margin-bottom: 20px;">
                        <h4 style="color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                            状态监控
                        </h4>
                        <div id="robot-status" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                            <div>状态: <span id="status-text" style="color: #28a745; font-weight: bold;">正常</span></div>
                            <div>最后更新: <span id="last-update">--</span></div>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h4 style="color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                            事件日志
                        </h4>
                        <div id="event-log" style="background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 11px;">
                            <div style="color: #666;">[启动] 机器人控制面板已加载</div>
                        </div>
                    </div>
                </div>
            `);
            
            // 绑定侧边栏按钮事件
            sidebarContent.find('.emergency-btn').on('click', function() {
                RED.actions.invoke("humanoid:emergency-stop");
            });
            
            sidebarContent.find('.reset-btn').on('click', function() {
                RED.actions.invoke("humanoid:reset-system");
            });
            
            // 注册重置系统动作
            RED.actions.add("humanoid:reset-system", function() {
                console.log("Reset system action triggered");
                RED.notify("🔄 系统重置中...", { type: "info", timeout: 3000 });
                
                // 更新状态显示
                updateRobotStatus("重置中", "warning");
                addEventLog("系统重置请求");
                
                // 模拟重置过程
                setTimeout(function() {
                    updateRobotStatus("正常", "success");
                    addEventLog("系统重置完成");
                    RED.notify("✅ 系统重置完成", { type: "success" });
                }, 2000);
            });
            
            // 添加到侧边栏
            RED.sidebar.addTab({
                id: "humanoid-control",
                label: "机器人",
                name: "机器人控制",
                iconClass: "fa fa-android",
                content: sidebarContent,
                enableOnEdit: false
            });
            
            console.log("DEBUG: Robot control sidebar added");
        }
        
        // 设置事件监听器（使用 RED.events API）
        function setupEventListeners() {
            // 监听急停事件
            RED.events.on("humanoid:emergency-stop", function(event) {
                console.log("Emergency stop event received:", event);
                updateRobotStatus("急停", "danger");
                addEventLog("紧急停止激活 - " + event.source);
            });
            
            // 监听部署事件
            RED.events.on("deploy", function() {
                addEventLog("流程已部署");
            });
            
            // 监听节点变化事件
            RED.events.on("nodes:add", function(node) {
                if (node.type.includes("robot") || node.type.includes("humanoid")) {
                    addEventLog("添加机器人节点: " + node.type);
                }
            });
            
            console.log("DEBUG: Event listeners setup complete");
        }
        
        // 更新机器人状态显示
        function updateRobotStatus(status, type) {
            var statusElement = $('#status-text');
            var lastUpdateElement = $('#last-update');
            
            if (statusElement.length > 0) {
                statusElement.text(status);
                statusElement.removeClass('text-success text-warning text-danger');
                
                switch(type) {
                    case 'success':
                        statusElement.css('color', '#28a745');
                        break;
                    case 'warning':
                        statusElement.css('color', '#ffc107');
                        break;
                    case 'danger':
                        statusElement.css('color', '#dc3545');
                        break;
                }
            }
            
            if (lastUpdateElement.length > 0) {
                lastUpdateElement.text(new Date().toLocaleTimeString());
            }
        }
        
        // 添加事件日志
        function addEventLog(message) {
            var logElement = $('#event-log');
            if (logElement.length > 0) {
                var timestamp = new Date().toLocaleTimeString();
                var logEntry = $(`<div style="color: #333; margin-bottom: 2px;">[${timestamp}] ${message}</div>`);
                logElement.append(logEntry);
                
                // 自动滚动到底部
                logElement.scrollTop(logElement[0].scrollHeight);
                
                // 限制日志条数
                var logs = logElement.children();
                if (logs.length > 50) {
                    logs.first().remove();
                }
            }
        }
        
        // 启动初始化
        waitForRED(initHumanoidUtils);
        
    })();

    // 注册节点类型（保持兼容性）
    RED.nodes.registerType('humanoid-utils', {
        category: 'config',
        color: '#a6bbcf',
        defaults: {
            name: {value: ""}
        },
        inputs: 0,
        outputs: 0,
        icon: "font-awesome/fa-android",
        label: function() {
            return this.name || "humanoid utils";
        }
    });
</script>